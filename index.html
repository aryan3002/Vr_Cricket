<!--
================================================================================
VR CRICKET PRO - Meta Quest 2 Photorealistic Edition
================================================================================

PHYSICS ENGINE DOCUMENTATION:

Ball Trajectory Calculation:
----------------------------
Using kinematic equations for projectile motion:
- Distance to travel: Œîz = z_target - z_start = 24-25m
- Time of flight: t = Œîz / v_horizontal
- Vertical velocity: vy = (y_target - y_start)/t + 0.5*g*t (compensates for gravity)
- Lateral velocity: vx = Œîx / t

Speed Conversions:
- Easy: 60-80 km/h = 16.7-22.2 m/s
- Medium: 100-130 km/h = 27.8-36.1 m/s  
- Hard: 140-160 km/h = 38.9-44.4 m/s

Pitch Bounce Physics:
- Coefficient of Restitution: 0.4-0.6 (cricket pitch)
- Bounce angle affected by pitch roughness and ball spin
- Seam position affects lateral movement after bounce

Magnus Effect (Spin):
- F_magnus = 0.5 * Cl * œÅ * A * v¬≤ (perpendicular to velocity and spin axis)
- Creates curve in ball trajectory
- Off-spin: ball curves from off to leg
- Leg-spin: ball curves from leg to off

Swing Physics:
- Differential air pressure due to ball seam orientation
- Inswing: seam angled towards batsman, ball curves in
- Outswing: seam angled away, ball curves away
- Reverse swing occurs with old ball (rough on one side)

CONTROLS:
- Right Controller: Cricket bat (swing to hit)
- Left Trigger: Ready for next ball
- Right Grip: Pause game
- A/X Button: Change stance

Enjoy photorealistic VR cricket! üèè
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Cricket Pro - Quest 2 Photorealistic Edition</title>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- A-Frame Extras for better physics -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0a1f0a 0%, #1a3a1a 100%);
        }
        
        /* Main Menu Overlay - Enhanced */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 31, 10, 0.97) 0%, rgba(26, 58, 26, 0.97) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #menu-overlay.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7), 0 0 30px rgba(255,215,0,0.3);
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .menu-subtitle {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.8;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .menu-section {
            margin: 0.8rem 0;
            text-align: center;
        }
        
        .menu-section h3 {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .menu-btn {
            padding: 10px 20px;
            font-size: 0.95rem;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 100px;
            backdrop-filter: blur(5px);
        }
        
        .menu-btn:hover, .menu-btn.active {
            background: rgba(255,215,0,0.9);
            color: #0a1f0a;
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.3);
        }
        
        .menu-btn.primary {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border-color: #ffd700;
            color: #0a1f0a;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 15px 50px;
            box-shadow: 0 5px 30px rgba(255,215,0,0.4);
        }
        
        .menu-btn.primary:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 10px 40px rgba(255,215,0,0.5);
        }
        
        .instructions {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            max-width: 500px;
            text-align: left;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .instructions h4 {
            margin-bottom: 0.5rem;
            color: #ffd700;
        }
        
        /* Enhanced In-Game HUD */
        #game-hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,20,0.85));
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 100;
            min-width: 220px;
            border: 1px solid rgba(255,215,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        #game-hud.hidden {
            display: none;
        }
        
        .hud-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            padding: 2px 0;
        }
        
        .hud-label {
            opacity: 0.7;
        }
        
        .hud-value {
            font-weight: bold;
            color: #ffd700;
        }
        
        .hud-score {
            font-size: 2.5rem;
            text-align: center;
            border-bottom: 2px solid rgba(255,215,0,0.3);
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        
        /* Ball Speed Display */
        #ball-speed-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,20,0.85));
            color: #00ff88;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 100;
            border: 1px solid rgba(0,255,136,0.3);
            text-align: center;
            min-width: 120px;
        }
        
        #ball-speed-display.hidden {
            display: none;
        }
        
        #ball-speed-display .speed-value {
            font-size: 2rem;
        }
        
        #ball-speed-display .speed-unit {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        /* Timing Indicator */
        #timing-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        #timing-indicator.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        #timing-indicator.perfect {
            color: #00ff88;
            text-shadow: 0 0 30px rgba(0,255,136,0.8);
        }
        
        #timing-indicator.good {
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255,215,0,0.8);
        }
        
        #timing-indicator.poor {
            color: #ff6b6b;
            text-shadow: 0 0 30px rgba(255,107,107,0.8);
        }
        
        /* Shot Feedback - Enhanced */
        #shot-feedback {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.9), 0 0 40px currentColor;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s, transform 0.4s;
        }
        
        #shot-feedback.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        #shot-feedback.four {
            color: #00ff88;
        }
        
        #shot-feedback.six {
            color: #ffd700;
            animation: pulse-gold 0.5s ease-in-out;
        }
        
        #shot-feedback.out {
            color: #ff4444;
        }
        
        #shot-feedback.runs {
            color: #4fc3f7;
        }
        
        @keyframes pulse-gold {
            0%, 100% { transform: translate(-50%, -50%) scale(1.1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
        }
        
        /* Wagon Wheel Container */
        #wagon-wheel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 100;
        }
        
        #wagon-wheel.hidden {
            display: none;
        }
        
        #wagon-wheel-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Pause Menu - Enhanced */
        #pause-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        #pause-menu.hidden {
            display: none;
        }
        
        #pause-menu h2 {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #ffd700;
        }
        
        /* Game Over Screen - Enhanced */
        #game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,10,0,0.95));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 600;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        #game-over.hidden {
            display: none;
        }
        
        #game-over h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 1.5rem 0;
            min-width: 400px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.08);
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,215,0,0.2);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
            border-color: rgba(255,215,0,0.5);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Debug Panel */
        #debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            z-index: 100;
            max-width: 300px;
            border: 1px solid #00ff00;
        }
        
        #debug-panel.hidden {
            display: none;
        }
        
        /* VR Button styling */
        .a-enter-vr-button {
            background: linear-gradient(135deg, #ffd700, #ff8c00) !important;
            color: #0a1f0a !important;
            font-weight: bold !important;
            border-radius: 8px !important;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a1f0a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="menu-overlay">
        <div class="menu-title">üèè VR CRICKET</div>
        <div class="menu-subtitle">Meta Quest 2 Edition</div>
        
        <div class="menu-section">
            <h3>Game Mode</h3>
            <div class="btn-group">
                <button class="menu-btn active" data-mode="practice">Practice</button>
                <button class="menu-btn" data-mode="challenge">Challenge</button>
                <button class="menu-btn" data-mode="survival">Survival</button>
                <button class="menu-btn" data-mode="target">Target Chase</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Difficulty</h3>
            <div class="btn-group">
                <button class="menu-btn" data-difficulty="easy">Easy</button>
                <button class="menu-btn active" data-difficulty="medium">Medium</button>
                <button class="menu-btn" data-difficulty="hard">Hard</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Overs (Challenge/Target Mode)</h3>
            <div class="btn-group">
                <button class="menu-btn active" data-overs="1">1 Over</button>
                <button class="menu-btn" data-overs="2">2 Overs</button>
                <button class="menu-btn" data-overs="4">4 Overs</button>
            </div>
        </div>
        
        <div class="menu-section" style="margin-top: 2rem;">
            <button class="menu-btn primary" id="start-btn">‚ñ∂ START GAME</button>
        </div>
        
        <div class="instructions">
            <h4>üéÆ Controls:</h4>
            <p>‚Ä¢ <strong>Right Controller</strong> - Cricket bat (swing to hit)</p>
            <p>‚Ä¢ <strong>Left Trigger</strong> - Ready for next ball</p>
            <p>‚Ä¢ <strong>Right Grip</strong> - Pause game</p>
            <p>‚Ä¢ <strong>Left Grip</strong> - Reset position</p>
            <p style="margin-top: 10px; opacity: 0.7;">Click the VR button to enter immersive mode!</p>
        </div>
    </div>
    
    <!-- In-Game HUD -->
    <div id="game-hud" class="hidden">
        <div class="hud-score">
            <span id="hud-runs">0</span>/<span id="hud-wickets">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Balls:</span>
            <span class="hud-value" id="hud-balls">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Fours:</span>
            <span class="hud-value" id="hud-fours">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Sixes:</span>
            <span class="hud-value" id="hud-sixes">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Strike Rate:</span>
            <span class="hud-value" id="hud-sr">0.00</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Last Shot:</span>
            <span class="hud-value" id="hud-shot">-</span>
        </div>
        <div class="hud-row" id="hud-target-row" style="display: none;">
            <span class="hud-label">Target:</span>
            <span class="hud-value" id="hud-target">0</span>
        </div>
    </div>
    
    <!-- Shot Feedback -->
    <div id="shot-feedback"></div>
    
    <!-- Timing Indicator -->
    <div id="timing-indicator"></div>
    
    <!-- Ball Speed Display -->
    <div id="ball-speed-display" class="hidden">
        <div class="speed-value">0</div>
        <div class="speed-unit">km/h</div>
    </div>
    
    <!-- Pause Menu -->
    <div id="pause-menu" class="hidden">
        <h2>‚è∏ PAUSED</h2>
        <div class="btn-group" style="flex-direction: column;">
            <button class="menu-btn" id="resume-btn">‚ñ∂ Resume</button>
            <button class="menu-btn" id="restart-btn">üîÑ Restart</button>
            <button class="menu-btn" id="quit-btn">üè† Main Menu</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="game-over" class="hidden">
        <h2 id="game-over-title">INNINGS OVER</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="final-score">0</div>
                <div class="stat-label">Runs Scored</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-balls">0</div>
                <div class="stat-label">Balls Faced</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-fours">0</div>
                <div class="stat-label">Fours</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-sixes">0</div>
                <div class="stat-label">Sixes</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-sr">0.00</div>
                <div class="stat-label">Strike Rate</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-best">-</div>
                <div class="stat-label">Best Shot</div>
            </div>
        </div>
        <div class="btn-group" style="margin-top: 1rem;">
            <button class="menu-btn primary" id="play-again-btn">üèè Play Again</button>
            <button class="menu-btn" id="menu-btn">üè† Main Menu</button>
        </div>
    </div>
    
    <!-- A-Frame Scene -->
    <a-scene 
        id="cricket-scene"
        vr-mode-ui="enabled: true"
        renderer="antialias: true; colorManagement: true;"
        loading-screen="dotsColor: #ffd700; backgroundColor: #1a472a">
        
        <!-- Assets -->
        <a-assets>
            <!-- Sounds -->
            <audio id="bat-hit-sound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" preload="auto"></audio>
        </a-assets>
        
        <!-- Sky and Environment -->
        <a-sky color="#87CEEB" id="sky"></a-sky>
        
        <!-- Sun -->
        <a-entity 
            light="type: directional; color: #FFF; intensity: 1.2; castShadow: true"
            position="50 100 50">
        </a-entity>
        
        <!-- Ambient Light -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5"></a-entity>
        
        <!-- Stadium/Environment -->
        <a-entity id="stadium">
            <!-- Main Ground (Grass) -->
            <a-cylinder 
                id="ground"
                position="0 -0.1 -11" 
                radius="80" 
                height="0.2" 
                color="#228B22"
                segments-radial="64">
            </a-cylinder>
            
            <!-- Pitch (Brown Strip) -->
            <a-box 
                id="pitch"
                position="0 0.01 -11" 
                width="3" 
                height="0.05" 
                depth="22" 
                color="#C4A35A">
            </a-box>
            
            <!-- Pitch Crease Lines -->
            <a-box position="0 0.02 0" width="2.5" height="0.02" depth="0.05" color="white"></a-box>
            <a-box position="0 0.02 -22" width="2.5" height="0.02" depth="0.05" color="white"></a-box>
            
            <!-- Boundary Rope -->
            <a-torus 
                id="boundary"
                position="0 0.1 -11" 
                radius="70" 
                radius-tubular="0.15" 
                color="#FFFFFF"
                rotation="90 0 0"
                segments-tubular="100">
            </a-torus>
            
            <!-- Boundary Markers (Flags) -->
            <a-entity id="boundary-markers"></a-entity>
        </a-entity>
        
        <!-- Stumps - Batsman End -->
        <a-entity id="batsman-stumps" position="0 0 0.5">
            <!-- Three Stumps -->
            <a-cylinder position="-0.115 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <a-cylinder position="0 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <a-cylinder position="0.115 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <!-- Bails -->
            <a-box id="bail-1" position="-0.0575 0.72 0" width="0.08" height="0.02" depth="0.015" color="#F5DEB3"></a-box>
            <a-box id="bail-2" position="0.0575 0.72 0" width="0.08" height="0.02" depth="0.015" color="#F5DEB3"></a-box>
        </a-entity>
        
        <!-- Stumps - Bowler End -->
        <a-entity id="bowler-stumps" position="0 0 -22">
            <a-cylinder position="-0.115 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <a-cylinder position="0 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <a-cylinder position="0.115 0.35 0" radius="0.015" height="0.71" color="#F5DEB3"></a-cylinder>
            <a-box position="-0.0575 0.72 0" width="0.08" height="0.02" depth="0.015" color="#F5DEB3"></a-box>
            <a-box position="0.0575 0.72 0" width="0.08" height="0.02" depth="0.015" color="#F5DEB3"></a-box>
        </a-entity>
        
        <!-- Bowler Character -->
        <a-entity id="bowler" position="0 0 -25">
            <!-- Body -->
            <a-cylinder position="0 0.9 0" radius="0.25" height="0.8" color="#FFFFFF"></a-cylinder>
            <!-- Head -->
            <a-sphere position="0 1.5 0" radius="0.2" color="#DEB887"></a-sphere>
            <!-- Arms -->
            <a-cylinder id="bowler-arm-right" position="0.35 1.1 0" radius="0.08" height="0.6" color="#DEB887" rotation="0 0 -30"></a-cylinder>
            <a-cylinder id="bowler-arm-left" position="-0.35 1.1 0" radius="0.08" height="0.6" color="#DEB887" rotation="0 0 30"></a-cylinder>
            <!-- Legs -->
            <a-cylinder position="0.15 0.3 0" radius="0.1" height="0.6" color="#FFFFFF"></a-cylinder>
            <a-cylinder position="-0.15 0.3 0" radius="0.1" height="0.6" color="#FFFFFF"></a-cylinder>
        </a-entity>
        
        <!-- Cricket Ball -->
        <a-sphere 
            id="cricket-ball"
            position="0 1.5 -24"
            radius="0.15"
            color="#FF0000"
            visible="false"
            material="shader: flat; emissive: #FF0000; emissiveIntensity: 0.5"
            shadow="receive: false">
            <!-- Ball seam -->
            <a-torus position="0 0 0" radius="0.15" radius-tubular="0.01" color="#FFFFFF" rotation="0 0 0"></a-torus>
        </a-sphere>
        
        <!-- Ball Trail -->
        <a-entity id="ball-trail"></a-entity>
        
        <!-- Fielders -->
        <a-entity id="fielders">
            <!-- Slip Fielder -->
            <a-entity class="fielder" id="fielder-slip" position="3 0 2">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Point Fielder -->
            <a-entity class="fielder" id="fielder-point" position="12 0 -5">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Cover Fielder -->
            <a-entity class="fielder" id="fielder-cover" position="15 0 -15">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Mid-off Fielder -->
            <a-entity class="fielder" id="fielder-midoff" position="8 0 -25">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Mid-on Fielder -->
            <a-entity class="fielder" id="fielder-midon" position="-8 0 -25">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Square Leg Fielder -->
            <a-entity class="fielder" id="fielder-squareleg" position="-12 0 -5">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Fine Leg Fielder -->
            <a-entity class="fielder" id="fielder-fineleg" position="-8 0 10">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Third Man Fielder -->
            <a-entity class="fielder" id="fielder-thirdman" position="8 0 10">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Long-off Boundary -->
            <a-entity class="fielder" id="fielder-longoff" position="20 0 -50">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Long-on Boundary -->
            <a-entity class="fielder" id="fielder-longon" position="-20 0 -50">
                <a-cylinder position="0 0.7 0" radius="0.2" height="1" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.4 0" radius="0.15" color="#DEB887"></a-sphere>
            </a-entity>
            
            <!-- Wicket Keeper -->
            <a-entity class="fielder" id="wicket-keeper" position="0 0 2">
                <a-cylinder position="0 0.5 0" radius="0.2" height="0.8" color="#FFFFFF"></a-cylinder>
                <a-sphere position="0 1.1 0" radius="0.15" color="#DEB887"></a-sphere>
                <!-- Gloves -->
                <a-sphere position="0.3 0.7 -0.2" radius="0.1" color="#8B4513"></a-sphere>
                <a-sphere position="-0.3 0.7 -0.2" radius="0.1" color="#8B4513"></a-sphere>
            </a-entity>
        </a-entity>
        
        <!-- VR Camera Rig -->
        <a-entity id="rig" position="0 0 0">
            <a-camera id="camera" position="0 1.6 0" wasd-controls-enabled="false"></a-camera>
            
            <!-- Left Hand Controller (Menu) -->
            <a-entity 
                id="left-hand"
                oculus-touch-controls="hand: left"
                laser-controls="hand: left">
            </a-entity>
            
            <!-- Right Hand Controller (Bat) -->
            <a-entity 
                id="right-hand"
                oculus-touch-controls="hand: right">
                
                <!-- Cricket Bat Model -->
                <a-entity id="cricket-bat" rotation="-90 0 0" position="0 0 -0.1">
                    <!-- Bat Handle -->
                    <a-cylinder 
                        position="0 0.15 0" 
                        radius="0.02" 
                        height="0.35" 
                        color="#8B4513">
                    </a-cylinder>
                    
                    <!-- Bat Handle Grip -->
                    <a-cylinder 
                        position="0 0.05 0" 
                        radius="0.022" 
                        height="0.15" 
                        color="#2F4F4F">
                    </a-cylinder>
                    
                    <!-- Bat Blade -->
                    <a-box 
                        id="bat-blade"
                        position="0 0.55 0" 
                        width="0.11" 
                        height="0.5" 
                        depth="0.04" 
                        color="#F5DEB3">
                    </a-box>
                    
                    <!-- Bat Edge (Left) -->
                    <a-box 
                        position="-0.055 0.55 0" 
                        width="0.01" 
                        height="0.5" 
                        depth="0.05" 
                        color="#DEB887">
                    </a-box>
                    
                    <!-- Bat Edge (Right) -->
                    <a-box 
                        position="0.055 0.55 0" 
                        width="0.01" 
                        height="0.5" 
                        depth="0.05" 
                        color="#DEB887">
                    </a-box>
                    
                    <!-- Bat Toe -->
                    <a-box 
                        position="0 0.82 0" 
                        width="0.11" 
                        height="0.04" 
                        depth="0.04" 
                        color="#DEB887"
                        rotation="0 0 0">
                    </a-box>
                    
                    <!-- Sweet Spot Marker (Visual Guide) -->
                    <a-box 
                        id="sweet-spot"
                        position="0 0.5 0.025" 
                        width="0.06" 
                        height="0.15" 
                        depth="0.001" 
                        color="#FFD700"
                        opacity="0.3">
                    </a-box>
                </a-entity>
            </a-entity>
        </a-entity>
        
        <!-- In-VR Score Display -->
        <a-entity id="vr-hud" position="0 2.5 -3" look-at="[camera]">
            <a-plane 
                position="0 0 0" 
                width="2" 
                height="0.8" 
                color="#000000" 
                opacity="0.7"
                visible="false"
                id="vr-scoreboard">
            </a-plane>
            <a-text 
                id="vr-score-text"
                value="0/0"
                align="center"
                position="0 0.15 0.01"
                scale="1.5 1.5 1.5"
                color="#FFFFFF"
                visible="false">
            </a-text>
            <a-text 
                id="vr-balls-text"
                value="Balls: 0"
                align="center"
                position="0 -0.1 0.01"
                scale="0.7 0.7 0.7"
                color="#CCCCCC"
                visible="false">
            </a-text>
            <a-text 
                id="vr-shot-text"
                value=""
                align="center"
                position="0 -0.25 0.01"
                scale="0.5 0.5 0.5"
                color="#FFD700"
                visible="false">
            </a-text>
        </a-entity>
        
        <!-- Hit Effect Particles -->
        <a-entity id="hit-particles" position="0 1 0" visible="false">
            <a-sphere radius="0.05" color="#FFD700" opacity="0.8"></a-sphere>
        </a-entity>
        
    </a-scene>

    <script>
    // ============================================================================
    // VR CRICKET GAME - Main Game Logic
    // ============================================================================
    
    (function() {
        'use strict';
        
        // ========================================================================
        // GAME CONFIGURATION
        // ========================================================================
        
        const CONFIG = {
            // =================================================================
            // PITCH DIMENSIONS (in meters, real cricket proportions)
            // =================================================================
            pitchLength: 22,        // Standard cricket pitch = 22 yards = 20.12m
            boundaryDistance: 70,   // Typical boundary distance
            
            // Batsman position (where player stands)
            batsmanZ: 0,           // Batsman at z = 0
            bowlerZ: -24,          // Bowler releases at z = -24
            
            // =================================================================
            // BALL PHYSICS - Realistic Cricket Ball Properties
            // =================================================================
            ballRadius: 0.036,      // Cricket ball radius (~7.2cm diameter)
            ballMass: 0.163,        // Cricket ball mass in kg (156-163g)
            
            // Gravity (m/s¬≤)
            gravity: -9.81,
            
            // Air resistance coefficient (drag)
            // Higher = more drag, ball slows down more
            airResistance: 0.995,   // Very slight air drag per frame
            
            // Ground/pitch properties
            groundFriction: 0.75,   // Friction when ball rolls on ground
            pitchBounceCoefficient: 0.5,  // Coefficient of restitution for pitch (0.4-0.6 realistic)
            
            // =================================================================
            // BALL SPEEDS (meters per second)
            // Converted from km/h: divide by 3.6
            // Easy: 60-80 km/h = 16.7-22.2 m/s
            // Medium: 100-130 km/h = 27.8-36.1 m/s
            // Hard: 140-160 km/h = 38.9-44.4 m/s
            // =================================================================
            speeds: {
                easy:   { min: 16, max: 22 },    // 60-80 km/h - Very playable
                medium: { min: 25, max: 32 },    // 90-115 km/h - Challenging
                hard:   { min: 35, max: 42 }     // 125-150 km/h - Professional pace
            },
            
            // =================================================================
            // BAT PROPERTIES
            // =================================================================
            batLength: 0.85,        // Standard bat length
            batWidth: 0.11,         // Bat blade width
            sweetSpotSize: 0.12,    // Sweet spot radius
            edgeWidth: 0.015,       // Edge thickness
            
            // Collision detection radius (generous for playability)
            batCollisionRadius: 0.35,
            
            // =================================================================
            // TIMING WINDOWS (seconds)
            // =================================================================
            timing: {
                perfect: 0.04,      // ¬±40ms for perfect timing
                good: 0.08,         // ¬±80ms for good timing
                fair: 0.12          // ¬±120ms for fair timing
            },
            
            // =================================================================
            // SCORING
            // =================================================================
            boundaryFour: 4,
            boundarySix: 6,
            
            // =================================================================
            // GAME SETTINGS
            // =================================================================
            ballsPerOver: 6,
            wicketsPerInnings: 1,
            
            // Debug mode (set to true to see trajectory predictions)
            debugMode: false
        };
        
        // ========================================================================
        // GAME STATE
        // ========================================================================
        
        const GameState = {
            // Game settings
            mode: 'practice', // practice, challenge, survival, target
            difficulty: 'medium',
            totalOvers: 1,
            targetScore: 0,
            
            // Current game state
            isPlaying: false,
            isPaused: false,
            isGameOver: false,
            isBallInPlay: false,
            isReadyForBall: false,
            
            // Score tracking
            runs: 0,
            wickets: 0,
            ballsFaced: 0,
            fours: 0,
            sixes: 0,
            dotBalls: 0,
            bestShot: '',
            highScore: localStorage.getItem('cricketHighScore') || 0,
            
            // Ball state
            ballPosition: { x: 0, y: 1.5, z: -24 },
            ballVelocity: { x: 0, y: 0, z: 0 },
            ballSpin: { x: 0, y: 0, z: 0 },
            ballHasBouncedOnPitch: false,
            ballHitByBat: false,
            
            // Bat tracking
            batPosition: { x: 0, y: 1, z: 0 },
            batPrevPosition: { x: 0, y: 1, z: 0 },
            batVelocity: { x: 0, y: 0, z: 0 },
            batRotation: { x: 0, y: 0, z: 0 },
            
            // Delivery info
            currentDeliveryType: 'good-length',
            currentLine: 'middle',
            
            // Reset game state
            reset: function() {
                this.runs = 0;
                this.wickets = 0;
                this.ballsFaced = 0;
                this.fours = 0;
                this.sixes = 0;
                this.dotBalls = 0;
                this.bestShot = '';
                this.isPlaying = true;
                this.isPaused = false;
                this.isGameOver = false;
                this.isBallInPlay = false;
                this.isReadyForBall = true;
                this.ballHasBouncedOnPitch = false;
                this.ballHitByBat = false;
            },
            
            // Calculate strike rate
            getStrikeRate: function() {
                if (this.ballsFaced === 0) return 0;
                return ((this.runs / this.ballsFaced) * 100).toFixed(2);
            },
            
            // Get remaining balls
            getRemainingBalls: function() {
                if (this.mode === 'practice') return '‚àû';
                return (this.totalOvers * CONFIG.ballsPerOver) - this.ballsFaced;
            },
            
            // Check if innings should end
            checkInningsEnd: function() {
                if (this.mode === 'practice') return false;
                
                if (this.mode === 'survival' && this.wickets >= 1) return true;
                if (this.mode === 'challenge' && this.ballsFaced >= this.totalOvers * CONFIG.ballsPerOver) return true;
                if (this.mode === 'target') {
                    if (this.runs >= this.targetScore) return true;
                    if (this.ballsFaced >= this.totalOvers * CONFIG.ballsPerOver) return true;
                    if (this.wickets >= 1) return true;
                }
                
                return false;
            }
        };
        
        // ========================================================================
        // AUDIO SYSTEM
        // ========================================================================
        
        const AudioSystem = {
            context: null,
            
            init: function() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            },
            
            // Generate a bat hit sound
            playBatHit: function(quality) {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                // Different sounds based on quality
                if (quality === 'perfect') {
                    oscillator.frequency.setValueAtTime(800, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, this.context.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.5, this.context.currentTime);
                } else if (quality === 'edge') {
                    oscillator.frequency.setValueAtTime(1200, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, this.context.currentTime + 0.05);
                    gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                } else {
                    oscillator.frequency.setValueAtTime(600, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, this.context.currentTime + 0.08);
                    gainNode.gain.setValueAtTime(0.4, this.context.currentTime);
                }
                
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.15);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.15);
            },
            
            // Ball hitting stumps
            playStumpsHit: function() {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(150, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, this.context.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.6, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            },
            
            // Crowd cheer
            playCrowdCheer: function(intensity) {
                if (!this.context) return;
                
                // Create noise for crowd
                const bufferSize = this.context.sampleRate * 0.5;
                const buffer = this.context.createBuffer(1, bufferSize, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.3;
                }
                
                const noise = this.context.createBufferSource();
                noise.buffer = buffer;
                
                const filter = this.context.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(intensity === 'six' ? 2000 : 1000, this.context.currentTime);
                
                const gainNode = this.context.createGain();
                gainNode.gain.setValueAtTime(intensity === 'six' ? 0.4 : 0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 1);
                
                noise.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                noise.start(this.context.currentTime);
                noise.stop(this.context.currentTime + 1);
            },
            
            // Ball bounce
            playBounce: function() {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(300, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, this.context.currentTime + 0.05);
                gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.05);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.05);
            }
        };
        
        // ========================================================================
        // BOWLING SYSTEM - PROPER PROJECTILE MOTION PHYSICS
        // ========================================================================
        // 
        // PHYSICS FORMULAS USED:
        // ----------------------
        // 1. Projectile Motion:
        //    - Horizontal: x(t) = x0 + vx*t
        //    - Vertical:   y(t) = y0 + vy*t + 0.5*g*t¬≤
        // 
        // 2. To hit a target at (targetX, targetY, targetZ) from (startX, startY, startZ):
        //    - Time of flight: t = (targetZ - startZ) / vz
        //    - Required vy: vy = (targetY - startY - 0.5*g*t¬≤) / t
        //    - Required vx: vx = (targetX - startX) / t
        // 
        // 3. For bouncing deliveries:
        //    - First phase: ball travels to bounce point
        //    - At bounce: vy reverses with coefficient of restitution
        //    - Second phase: ball travels from bounce to batsman
        //
        // ========================================================================
        
        const BowlingSystem = {
            
            // Current ball speed for display
            currentBallSpeed: 0,
            
            /**
             * Generate a random delivery based on difficulty
             */
            generateDelivery: function() {
                const difficulty = GameState.difficulty;
                const speedRange = CONFIG.speeds[difficulty];
                
                // Random speed within range (m/s)
                const speed = speedRange.min + Math.random() * (speedRange.max - speedRange.min);
                this.currentBallSpeed = speed;
                
                // Select delivery type based on difficulty
                const deliveryTypes = this.getDeliveryTypes(difficulty);
                const deliveryType = deliveryTypes[Math.floor(Math.random() * deliveryTypes.length)];
                
                // Line variation (off, middle, leg stump)
                const lines = ['off', 'middle', 'leg'];
                const lineWeights = difficulty === 'hard' ? [0.35, 0.35, 0.3] : [0.3, 0.4, 0.3];
                const line = this.weightedRandom(lines, lineWeights);
                
                GameState.currentDeliveryType = deliveryType;
                GameState.currentLine = line;
                
                // Calculate delivery parameters with proper physics
                const deliveryParams = this.calculateDeliveryPhysics(deliveryType, line, speed);
                
                // Log for debugging
                console.log(`üìç Delivery: ${deliveryType}, Line: ${line}, Speed: ${(speed * 3.6).toFixed(1)} km/h`);
                console.log(`üìç Start: (${deliveryParams.startPos.x.toFixed(2)}, ${deliveryParams.startPos.y.toFixed(2)}, ${deliveryParams.startPos.z.toFixed(2)})`);
                console.log(`üìç Velocity: (${deliveryParams.velocity.x.toFixed(2)}, ${deliveryParams.velocity.y.toFixed(2)}, ${deliveryParams.velocity.z.toFixed(2)})`);
                
                return {
                    speed: speed,
                    speedKmh: speed * 3.6,
                    type: deliveryType,
                    line: line,
                    ...deliveryParams
                };
            },
            
            /**
             * Get available delivery types based on difficulty
             */
            getDeliveryTypes: function(difficulty) {
                if (difficulty === 'easy') {
                    // Easy: mostly hittable deliveries
                    return ['good-length', 'half-volley', 'full-toss', 'good-length', 'half-volley'];
                } else if (difficulty === 'medium') {
                    // Medium: mix of deliveries
                    return ['good-length', 'half-volley', 'yorker', 'bouncer', 'full-toss'];
                } else {
                    // Hard: challenging deliveries
                    return ['good-length', 'yorker', 'bouncer', 'yorker', 'good-length', 'bouncer'];
                }
            },
            
            /**
             * Weighted random selection
             */
            weightedRandom: function(items, weights) {
                const totalWeight = weights.reduce((a, b) => a + b, 0);
                let random = Math.random() * totalWeight;
                
                for (let i = 0; i < items.length; i++) {
                    random -= weights[i];
                    if (random <= 0) return items[i];
                }
                return items[items.length - 1];
            },
            
            /**
             * CORE PHYSICS CALCULATION
             * Calculate proper projectile motion for cricket deliveries
             * 
             * @param {string} type - Delivery type (good-length, yorker, bouncer, etc.)
             * @param {string} line - Line of the delivery (off, middle, leg)
             * @param {number} speed - Ball speed in m/s
             * @returns {object} - Starting position and velocity vectors
             */
            calculateDeliveryPhysics: function(type, line, speed) {
                // =========================================================
                // STARTING POSITION (Bowler's release point)
                // =========================================================
                const startPos = {
                    x: 0,           // Center of pitch
                    y: 2.1,         // Release height (bowler's arm)
                    z: -24          // Bowler's end
                };
                
                // =========================================================
                // TARGET POSITION (Where ball should arrive at batsman)
                // =========================================================
                // Batsman stands at z = 0 to z = 1
                // We want ball to arrive at hitting zone
                
                let targetZ = 0.5;    // Default: reach batsman's crease
                let targetY = 1.0;    // Default: stump height
                let bounceZ = null;   // Z-position where ball bounces (null = no bounce)
                
                // =========================================================
                // DELIVERY TYPE PARAMETERS
                // Each delivery type has different target and bounce points
                // =========================================================
                
                switch (type) {
                    case 'full-toss':
                        // No bounce - arrives at waist to chest height
                        targetZ = 0.5;
                        targetY = 1.0 + Math.random() * 0.3;  // 1.0-1.3m height
                        bounceZ = null;  // No bounce
                        break;
                        
                    case 'half-volley':
                        // Bounces very close to batsman - easy to drive
                        targetZ = 0.5;
                        targetY = 0.6 + Math.random() * 0.3;  // Knee to thigh height
                        bounceZ = -2;    // Bounces 2m in front of batsman
                        break;
                        
                    case 'good-length':
                        // Classic delivery - bounces 6-8m before stumps
                        targetZ = 0.5;
                        targetY = 0.9 + Math.random() * 0.4;  // Stump to chest height
                        bounceZ = -7 + Math.random() * 2;     // Bounces 5-7m before batsman
                        break;
                        
                    case 'yorker':
                        // Pitches at batsman's feet - very low
                        targetZ = 0.3;
                        targetY = 0.15;   // Just above ground level
                        bounceZ = -0.3;   // Bounces right at the crease
                        break;
                        
                    case 'bouncer':
                        // Short pitch - bounces early, rises to head height
                        targetZ = 0.5;
                        targetY = 1.6 + Math.random() * 0.3;  // Chest to head height
                        bounceZ = -12 + Math.random() * 2;    // Bounces 10-12m before batsman
                        break;
                        
                    default:
                        // Default to good length
                        targetZ = 0.5;
                        targetY = 1.0;
                        bounceZ = -6;
                }
                
                // =========================================================
                // LINE ADJUSTMENT (Lateral offset)
                // =========================================================
                let targetX = 0;
                if (line === 'off') {
                    targetX = 0.2 + Math.random() * 0.15;   // Outside off stump
                } else if (line === 'leg') {
                    targetX = -0.2 - Math.random() * 0.15;  // Down leg side
                } else {
                    targetX = (Math.random() - 0.5) * 0.2;  // Around middle stump
                }
                
                // =========================================================
                // PHYSICS CALCULATION
                // =========================================================
                
                let velocity;
                
                if (bounceZ === null) {
                    // =====================================================
                    // FULL TOSS (No bounce) - Direct trajectory
                    // =====================================================
                    velocity = this.calculateDirectTrajectory(startPos, targetX, targetY, targetZ, speed);
                } else {
                    // =====================================================
                    // BOUNCING DELIVERY - Two-phase trajectory
                    // =====================================================
                    velocity = this.calculateBouncingTrajectory(startPos, targetX, targetY, targetZ, bounceZ, speed);
                }
                
                // Add slight random variation for realism
                velocity.x += (Math.random() - 0.5) * 0.5;
                velocity.y += (Math.random() - 0.5) * 0.3;
                
                return {
                    startPos: startPos,
                    velocity: velocity,
                    bounceZ: bounceZ,
                    targetY: targetY,
                    targetX: targetX,
                    targetZ: targetZ
                };
            },
            
            /**
             * Calculate velocity for direct (non-bouncing) delivery
             * Uses projectile motion equations
             */
            calculateDirectTrajectory: function(startPos, targetX, targetY, targetZ, speed) {
                // Distance to travel
                const dz = targetZ - startPos.z;  // Will be positive (moving towards batsman)
                const dx = targetX - startPos.x;
                const dy = targetY - startPos.y;
                
                // The ball needs to travel distance dz at the given speed
                // Most of the speed is in the z-direction
                // Calculate time based on forward velocity
                
                // vz is the main component - ball speed is roughly the forward speed
                // We use 90% of speed for forward motion, rest for adjustments
                const vz = speed * 0.95;
                
                // Time to reach target
                const t = Math.abs(dz) / vz;
                
                // Required lateral velocity
                const vx = dx / t;
                
                // Required vertical velocity (accounting for gravity)
                // y(t) = y0 + vy*t + 0.5*g*t¬≤
                // targetY = startY + vy*t + 0.5*g*t¬≤
                // vy = (targetY - startY - 0.5*g*t¬≤) / t
                const g = CONFIG.gravity;  // Negative value
                const vy = (dy - 0.5 * g * t * t) / t;
                
                console.log(`‚ö° Direct trajectory: t=${t.toFixed(3)}s, vz=${vz.toFixed(2)}, vy=${vy.toFixed(2)}`);
                
                return { x: vx, y: vy, z: vz };
            },
            
            /**
             * Calculate velocity for bouncing delivery
             * Ball travels in two phases: before bounce and after bounce
             */
            calculateBouncingTrajectory: function(startPos, targetX, targetY, targetZ, bounceZ, speed) {
                // =========================================================
                // PHASE 1: From bowler to bounce point
                // =========================================================
                
                const bounceY = CONFIG.ballRadius;  // Ball bounces at ground level
                
                // Distance to bounce point
                const dz1 = bounceZ - startPos.z;
                
                // Forward velocity (main component of speed)
                const vz = speed * 0.95;
                
                // Time to reach bounce point
                const t1 = Math.abs(dz1) / vz;
                
                // We need to find vy such that ball hits the ground at bounceZ
                // Using: y(t1) = bounceY
                // startY + vy*t1 + 0.5*g*t1¬≤ = bounceY
                // vy = (bounceY - startY - 0.5*g*t1¬≤) / t1
                const g = CONFIG.gravity;
                const vy_initial = (bounceY - startPos.y - 0.5 * g * t1 * t1) / t1;
                
                // =========================================================
                // PHASE 2: After bounce (for reference - physics system handles this)
                // =========================================================
                // After bounce, vy reverses with coefficient of restitution
                // Ball continues to target
                
                // Calculate vx based on total flight to target
                const totalDz = targetZ - startPos.z;
                const totalTime = Math.abs(totalDz) / vz;
                const vx = (targetX - startPos.x) / totalTime;
                
                console.log(`‚ö° Bouncing trajectory: bounceZ=${bounceZ.toFixed(1)}, t1=${t1.toFixed(3)}s, vy=${vy_initial.toFixed(2)}`);
                
                return { x: vx, y: vy_initial, z: vz };
            },
            
            /**
             * Get current ball speed in km/h for display
             */
            getBallSpeedKmh: function() {
                return (this.currentBallSpeed * 3.6).toFixed(0);
            }
        };
        
        // ========================================================================
        // PHYSICS SYSTEM - Enhanced Ball Physics
        // ========================================================================
        
        const PhysicsSystem = {
            
            // Track bounce count
            bounceCount: 0,
            
            /**
             * Update ball position using physics simulation
             * Called every frame when ball is in play
             */
            updateBall: function(deltaTime) {
                if (!GameState.isBallInPlay) return;
                
                // Clamp deltaTime to prevent physics explosion
                deltaTime = Math.min(deltaTime, 0.05);
                
                const ball = GameState.ballPosition;
                const vel = GameState.ballVelocity;
                
                // =========================================================
                // GRAVITY
                // =========================================================
                vel.y += CONFIG.gravity * deltaTime;
                
                // =========================================================
                // AIR RESISTANCE (very subtle)
                // =========================================================
                vel.x *= CONFIG.airResistance;
                vel.z *= CONFIG.airResistance;
                
                // =========================================================
                // UPDATE POSITION
                // =========================================================
                ball.x += vel.x * deltaTime;
                ball.y += vel.y * deltaTime;
                ball.z += vel.z * deltaTime;
                
                // =========================================================
                // GROUND/PITCH COLLISION
                // =========================================================
                if (ball.y <= CONFIG.ballRadius) {
                    ball.y = CONFIG.ballRadius;
                    
                    // Bounce with coefficient of restitution
                    vel.y = -vel.y * CONFIG.pitchBounceCoefficient;
                    
                    // Apply friction to horizontal components
                    vel.x *= CONFIG.groundFriction;
                    vel.z *= CONFIG.groundFriction;
                    
                    this.bounceCount++;
                    
                    // Play bounce sound on first pitch bounce
                    if (!GameState.ballHasBouncedOnPitch && ball.z > -20 && ball.z < 5) {
                        GameState.ballHasBouncedOnPitch = true;
                        AudioSystem.playBounce();
                        console.log(`üèè Ball bounced at z=${ball.z.toFixed(2)}, new vy=${vel.y.toFixed(2)}`);
                    }
                    
                    // Ball has essentially stopped
                    if (Math.abs(vel.y) < 0.5 && Math.abs(vel.x) < 0.3 && Math.abs(vel.z) < 0.3) {
                        this.ballStopped();
                        return;
                    }
                }
                
                // =========================================================
                // BALL PASSED BATSMAN CHECK
                // =========================================================
                if (ball.z > 5 && !GameState.ballHitByBat) {
                    // Ball passed the batsman without being hit
                    console.log(`üèè Ball passed batsman at z=${ball.z.toFixed(2)}`);
                    this.ballStopped();
                    return;
                }
                
                // =========================================================
                // CHECK GAME EVENTS
                // =========================================================
                this.checkBoundary();
                this.checkStumps();
                this.checkFielderCatch();
                
                // =========================================================
                // UPDATE VISUAL
                // =========================================================
                const ballEntity = document.getElementById('cricket-ball');
                if (ballEntity) {
                    ballEntity.setAttribute('position', `${ball.x.toFixed(3)} ${ball.y.toFixed(3)} ${ball.z.toFixed(3)}`);
                }
                
                // Update ball trail
                this.updateBallTrail();
                
                // Debug logging (every 30 frames approx)
                if (CONFIG.debugMode && Math.random() < 0.03) {
                    console.log(`üîµ Ball: pos=(${ball.x.toFixed(2)}, ${ball.y.toFixed(2)}, ${ball.z.toFixed(2)}) vel=(${vel.x.toFixed(2)}, ${vel.y.toFixed(2)}, ${vel.z.toFixed(2)})`);
                }
            },
            
            // Check if ball crossed boundary
            checkBoundary: function() {
                if (!GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const distanceFromCenter = Math.sqrt(ball.x * ball.x + Math.pow(ball.z + 11, 2));
                
                if (distanceFromCenter >= CONFIG.boundaryDistance) {
                    // Check if it was a six (ball was in air) or four (bounced)
                    if (ball.y > 0.5) {
                        // Six!
                        GameState.runs += 6;
                        GameState.sixes++;
                        GameState.bestShot = 'SIX!';
                        showShotFeedback('SIX!', 'six');
                        AudioSystem.playCrowdCheer('six');
                    } else {
                        // Four!
                        GameState.runs += 4;
                        GameState.fours++;
                        GameState.bestShot = 'FOUR!';
                        showShotFeedback('FOUR!', 'four');
                        AudioSystem.playCrowdCheer('four');
                    }
                    
                    this.endDelivery();
                }
            },
            
            // Check if ball hit stumps
            checkStumps: function() {
                if (GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const stumpsPos = { x: 0, y: 0.35, z: 0.5 };
                
                // Check if ball is near stumps
                if (ball.z > 0.3 && ball.z < 0.7 &&
                    Math.abs(ball.x) < 0.15 &&
                    ball.y < 0.75 && ball.y > 0) {
                    
                    // BOWLED!
                    GameState.wickets++;
                    showShotFeedback('BOWLED!', 'out');
                    AudioSystem.playStumpsHit();
                    
                    // Animate bails
                    this.animateBails();
                    
                    this.endDelivery();
                }
            },
            
            // Check for catches
            checkFielderCatch: function() {
                if (!GameState.ballHitByBat) return;
                if (GameState.ballPosition.y <= 0.3) return; // Ball too low
                
                const ball = GameState.ballPosition;
                const fielders = document.querySelectorAll('.fielder');
                
                fielders.forEach(fielder => {
                    const pos = fielder.getAttribute('position');
                    const distance = Math.sqrt(
                        Math.pow(ball.x - pos.x, 2) +
                        Math.pow(ball.z - pos.z, 2)
                    );
                    
                    // Catch radius depends on difficulty
                    const catchRadius = GameState.difficulty === 'easy' ? 1 : 
                                       GameState.difficulty === 'medium' ? 1.5 : 2;
                    
                    if (distance < catchRadius && ball.y > 0.3 && ball.y < 3) {
                        // Random catch success based on difficulty
                        const catchChance = GameState.difficulty === 'easy' ? 0.3 :
                                           GameState.difficulty === 'medium' ? 0.5 : 0.7;
                        
                        if (Math.random() < catchChance) {
                            // CAUGHT!
                            GameState.wickets++;
                            showShotFeedback('CAUGHT!', 'out');
                            this.endDelivery();
                        }
                    }
                });
            },
            
            // Ball stopped rolling
            ballStopped: function() {
                if (!GameState.ballHitByBat) {
                    // Missed the ball - check if it was a wide or passed stumps
                    const ball = GameState.ballPosition;
                    if (ball.z > 2) {
                        // Ball passed - could be wide or keeper stopped it
                        this.endDelivery();
                    }
                } else {
                    // Calculate runs based on where ball stopped
                    const ball = GameState.ballPosition;
                    const distanceFromCenter = Math.sqrt(ball.x * ball.x + Math.pow(ball.z + 11, 2));
                    
                    let runs = 0;
                    if (distanceFromCenter > 50) runs = 3;
                    else if (distanceFromCenter > 30) runs = 2;
                    else if (distanceFromCenter > 15) runs = 1;
                    
                    if (runs > 0) {
                        GameState.runs += runs;
                        showShotFeedback(`${runs} RUN${runs > 1 ? 'S' : ''}`, 'runs');
                    } else {
                        GameState.dotBalls++;
                        showShotFeedback('DOT BALL', 'runs');
                    }
                    
                    this.endDelivery();
                }
            },
            
            // Animate bails falling
            animateBails: function() {
                const bail1 = document.getElementById('bail-1');
                const bail2 = document.getElementById('bail-2');
                
                if (bail1) {
                    bail1.setAttribute('animation', {
                        property: 'position',
                        to: '-0.1 0.5 0.2',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                    bail1.setAttribute('animation__rot', {
                        property: 'rotation',
                        to: '45 30 60',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                }
                
                if (bail2) {
                    bail2.setAttribute('animation', {
                        property: 'position',
                        to: '0.1 0.5 0.2',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                    bail2.setAttribute('animation__rot', {
                        property: 'rotation',
                        to: '-45 -30 -60',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                }
            },
            
            // Reset bails position
            resetBails: function() {
                const bail1 = document.getElementById('bail-1');
                const bail2 = document.getElementById('bail-2');
                
                if (bail1) {
                    bail1.removeAttribute('animation');
                    bail1.removeAttribute('animation__rot');
                    bail1.setAttribute('position', '-0.0575 0.72 0');
                    bail1.setAttribute('rotation', '0 0 0');
                }
                
                if (bail2) {
                    bail2.removeAttribute('animation');
                    bail2.removeAttribute('animation__rot');
                    bail2.setAttribute('position', '0.0575 0.72 0');
                    bail2.setAttribute('rotation', '0 0 0');
                }
            },
            
            // Update ball trail
            updateBallTrail: function() {
                // Simple trail using position markers
                const trailContainer = document.getElementById('ball-trail');
                if (!trailContainer) return;
                
                // Create trail marker - make it larger and brighter
                const marker = document.createElement('a-sphere');
                marker.setAttribute('position', `${GameState.ballPosition.x} ${GameState.ballPosition.y} ${GameState.ballPosition.z}`);
                marker.setAttribute('radius', '0.08');
                marker.setAttribute('color', '#FFD700');
                marker.setAttribute('opacity', '0.7');
                marker.setAttribute('material', 'shader: flat; emissive: #FFD700; emissiveIntensity: 0.8');
                
                trailContainer.appendChild(marker);
                
                // Remove after delay
                setTimeout(() => {
                    if (marker.parentNode) {
                        marker.parentNode.removeChild(marker);
                    }
                }, 500);
            },
            
            // End current delivery
            endDelivery: function() {
                GameState.isBallInPlay = false;
                GameState.ballsFaced++;
                
                // Update UI
                updateHUD();
                
                // Check if innings should end
                if (GameState.checkInningsEnd()) {
                    endGame();
                } else {
                    // Prepare for next ball
                    setTimeout(() => {
                        GameState.isReadyForBall = true;
                        hideBall();
                        this.resetBails();
                        
                        // Auto-bowl in practice mode
                        if (GameState.mode === 'practice') {
                            setTimeout(() => {
                                if (GameState.isPlaying && !GameState.isPaused) {
                                    bowlBall();
                                }
                            }, 1500);
                        }
                    }, 1500);
                }
            }
        };
        
        // ========================================================================
        // BATTING SYSTEM
        // ========================================================================
        
        const BattingSystem = {
            lastFrameTime: 0,
            velocityHistory: [],
            
            // Update bat tracking
            updateBat: function(position, rotation) {
                const now = performance.now();
                const deltaTime = (now - this.lastFrameTime) / 1000;
                this.lastFrameTime = now;
                
                if (deltaTime > 0 && deltaTime < 0.1) {
                    // Calculate velocity
                    GameState.batVelocity = {
                        x: (position.x - GameState.batPrevPosition.x) / deltaTime,
                        y: (position.y - GameState.batPrevPosition.y) / deltaTime,
                        z: (position.z - GameState.batPrevPosition.z) / deltaTime
                    };
                    
                    // Store velocity history for averaging
                    this.velocityHistory.push({...GameState.batVelocity});
                    if (this.velocityHistory.length > 5) {
                        this.velocityHistory.shift();
                    }
                }
                
                // Update previous position
                GameState.batPrevPosition = {...position};
                GameState.batPosition = position;
                GameState.batRotation = rotation;
            },
            
            // Get average bat velocity
            getAverageVelocity: function() {
                if (this.velocityHistory.length === 0) {
                    return { x: 0, y: 0, z: 0 };
                }
                
                const avg = { x: 0, y: 0, z: 0 };
                this.velocityHistory.forEach(v => {
                    avg.x += v.x;
                    avg.y += v.y;
                    avg.z += v.z;
                });
                
                avg.x /= this.velocityHistory.length;
                avg.y /= this.velocityHistory.length;
                avg.z /= this.velocityHistory.length;
                
                return avg;
            },
            
            // Get bat speed
            getBatSpeed: function() {
                const vel = this.getAverageVelocity();
                return Math.sqrt(vel.x * vel.x + vel.y * vel.y + vel.z * vel.z);
            },
            
            // Check bat-ball collision
            checkCollision: function() {
                if (!GameState.isBallInPlay || GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const bat = GameState.batPosition;
                
                // Get bat world position (accounting for controller position)
                const rightHand = document.getElementById('right-hand');
                if (!rightHand) return;
                
                const batWorldPos = rightHand.object3D.position.clone();
                const batEntity = document.getElementById('cricket-bat');
                if (batEntity) {
                    // Add bat offset
                    batWorldPos.y += 0.5; // Bat blade center
                }
                
                // Calculate distance to bat blade
                const dx = ball.x - batWorldPos.x;
                const dy = ball.y - batWorldPos.y;
                const dz = ball.z - batWorldPos.z;
                const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                
                // Collision threshold - use config value
                const collisionThreshold = CONFIG.batCollisionRadius;
                
                if (distance < collisionThreshold) {
                    console.log(`üèè BAT-BALL COLLISION! Distance: ${distance.toFixed(3)}`);
                    this.handleHit(batWorldPos, distance);
                }
            },
            
            /**
             * Handle bat hitting ball
             * Calculate shot power, direction, and trigger feedback
             */
            handleHit: function(batWorldPos, collisionDistance) {
                GameState.ballHitByBat = true;
                
                // Get bat velocity and speed
                const batVel = this.getAverageVelocity();
                const batSpeed = this.getBatSpeed();
                
                // Determine hit quality based on contact point
                const ball = GameState.ballPosition;
                const hitQuality = this.calculateHitQuality(ball, batWorldPos, collisionDistance);
                
                // Show timing indicator
                showTimingIndicator(hitQuality);
                
                // Determine shot type based on bat movement
                const shotType = this.determineShotType(batVel, GameState.batRotation);
                
                // Calculate new ball velocity
                const powerMultiplier = this.getPowerMultiplier(hitQuality);
                const baseSpeed = Math.max(batSpeed * powerMultiplier * 2, 10); // Minimum speed of 10 m/s
                
                // Direction based on shot type and bat angle
                let newVel = this.calculateShotVelocity(shotType, batVel, baseSpeed, hitQuality);
                
                GameState.ballVelocity = newVel;
                
                console.log(`üèè Shot: ${shotType}, Quality: ${hitQuality}, Speed: ${baseSpeed.toFixed(1)} m/s`);
                console.log(`üèè New ball velocity: (${newVel.x.toFixed(2)}, ${newVel.y.toFixed(2)}, ${newVel.z.toFixed(2)})`);
                
                // Visual and audio feedback
                this.showHitFeedback(hitQuality, shotType);
                AudioSystem.playBatHit(hitQuality);
                
                // Update HUD with shot type
                document.getElementById('hud-shot').textContent = shotType;
                const vrShotText = document.getElementById('vr-shot-text');
                if (vrShotText) {
                    vrShotText.setAttribute('value', shotType);
                }
            },
            
            /**
             * Calculate hit quality based on contact point
             * Perfect = sweet spot, Good = close to middle, Fair = off-center, Edge = bat edge
             */
            calculateHitQuality: function(ballPos, batPos, distance) {
                const dy = Math.abs(ballPos.y - batPos.y);
                const dx = Math.abs(ballPos.x - batPos.x);
                
                // Use collision distance for quality assessment
                const sweetSpotThreshold = CONFIG.sweetSpotSize;
                
                // Sweet spot detection
                if (distance < sweetSpotThreshold && dy < 0.1 && dx < 0.05) {
                    return 'perfect';
                } else if (distance < sweetSpotThreshold * 1.5 && dy < 0.15) {
                    return 'good';
                } else if (dx > 0.08) {
                    return 'edge';
                } else {
                    return 'fair';
                }
            },
            
            /**
             * Determine shot type based on bat movement direction
             */
            determineShotType: function(velocity, rotation) {
                const vx = velocity.x;
                const vy = velocity.y;
                const vz = velocity.z;
                
                // Horizontal vs vertical movement
                const horizontalSpeed = Math.sqrt(vx * vx + vz * vz);
                const verticalSpeed = Math.abs(vy);
                
                // Direction of horizontal movement
                const isOffSide = vx > 0.5;
                const isLegSide = vx < -0.5;
                const isForward = vz < -0.5;
                const isBackward = vz > 0.5;
                
                // Determine shot
                if (verticalSpeed > horizontalSpeed * 1.5) {
                    if (vy > 0) {
                        return 'Lofted Shot';
                    } else {
                        return 'Defensive Block';
                    }
                }
                
                if (isForward) {
                    if (isOffSide) return 'Cover Drive';
                    if (isLegSide) return 'On Drive';
                    return 'Straight Drive';
                }
                
                if (isBackward) {
                    if (isOffSide) return 'Late Cut';
                    if (isLegSide) return 'Flick';
                    return 'Defensive';
                }
                
                if (horizontalSpeed > 3) {
                    if (isOffSide) return 'Cut Shot';
                    if (isLegSide) return 'Pull Shot';
                }
                
                return 'Shot';
            },
            
            /**
             * Get power multiplier based on hit quality
             */
            getPowerMultiplier: function(quality) {
                switch (quality) {
                    case 'perfect': return 1.8;  // Sweet spot = maximum power
                    case 'good': return 1.4;
                    case 'fair': return 1.0;
                    case 'edge': return 0.5;     // Edge = much less power
                    default: return 0.8;
                }
            },
            
            /**
             * Calculate ball velocity after being hit
             * Uses bat velocity and quality to determine shot power and direction
             */
            calculateShotVelocity: function(shotType, batVel, baseSpeed, quality) {
                let vx = 0, vy = 0, vz = 0;
                
                // Base direction from bat velocity
                const batMag = Math.sqrt(batVel.x * batVel.x + batVel.y * batVel.y + batVel.z * batVel.z);
                if (batMag > 0) {
                    vx = (batVel.x / batMag) * baseSpeed;
                    vy = (batVel.y / batMag) * baseSpeed;
                    vz = (batVel.z / batMag) * baseSpeed;
                }
                
                // Ensure ball goes away from batsman
                if (vz > 0) vz = -vz;
                
                // Add upward component for lofted shots
                if (Math.abs(batVel.y) > 2) {
                    vy = Math.abs(vy) * 0.5;
                }
                
                // Edge deflection
                if (quality === 'edge') {
                    vx += (Math.random() - 0.5) * baseSpeed * 0.5;
                    vz *= 0.3;
                }
                
                // Minimum forward velocity
                if (Math.abs(vz) < 5) {
                    vz = -5;
                }
                
                // Add slight randomness
                vx += (Math.random() - 0.5) * 2;
                vy += (Math.random() - 0.5) * 2;
                
                return { x: vx, y: Math.max(vy, 2), z: vz };
            },
            
            // Show hit feedback visuals
            showHitFeedback: function(quality, shotType) {
                const batBlade = document.getElementById('bat-blade');
                const sweetSpot = document.getElementById('sweet-spot');
                
                let color = '#FFFFFF';
                if (quality === 'perfect') color = '#00FF00';
                else if (quality === 'good') color = '#FFFF00';
                else if (quality === 'edge') color = '#FF0000';
                
                // Flash bat
                if (batBlade) {
                    batBlade.setAttribute('color', color);
                    setTimeout(() => {
                        batBlade.setAttribute('color', '#F5DEB3');
                    }, 200);
                }
                
                // Show hit particles
                const particles = document.getElementById('hit-particles');
                if (particles) {
                    particles.setAttribute('position', `${GameState.ballPosition.x} ${GameState.ballPosition.y} ${GameState.ballPosition.z}`);
                    particles.setAttribute('visible', 'true');
                    particles.querySelector('a-sphere').setAttribute('color', color);
                    
                    setTimeout(() => {
                        particles.setAttribute('visible', 'false');
                    }, 300);
                }
            }
        };
        
        // ========================================================================
        // UI FUNCTIONS
        // ========================================================================
        
        function showShotFeedback(text, type) {
            const feedback = document.getElementById('shot-feedback');
            feedback.textContent = text;
            feedback.className = `show ${type}`;
            
            setTimeout(() => {
                feedback.className = '';
            }, 1500);
        }
        
        /**
         * Show timing indicator when ball is hit
         * @param {string} quality - 'perfect', 'good', or 'poor'
         */
        function showTimingIndicator(quality) {
            const indicator = document.getElementById('timing-indicator');
            if (!indicator) return;
            
            let text = '';
            switch (quality) {
                case 'perfect':
                    text = '‚ö° PERFECT!';
                    break;
                case 'good':
                    text = 'üëç GOOD';
                    break;
                default:
                    text = 'üò¨ POOR';
            }
            
            indicator.textContent = text;
            indicator.className = `show ${quality}`;
            
            setTimeout(() => {
                indicator.className = '';
            }, 1000);
        }
        
        function updateHUD() {
            document.getElementById('hud-runs').textContent = GameState.runs;
            document.getElementById('hud-wickets').textContent = GameState.wickets;
            document.getElementById('hud-balls').textContent = GameState.ballsFaced;
            document.getElementById('hud-fours').textContent = GameState.fours;
            document.getElementById('hud-sixes').textContent = GameState.sixes;
            document.getElementById('hud-sr').textContent = GameState.getStrikeRate();
            
            // Update VR HUD
            const vrScoreText = document.getElementById('vr-score-text');
            const vrBallsText = document.getElementById('vr-balls-text');
            
            if (vrScoreText) {
                vrScoreText.setAttribute('value', `${GameState.runs}/${GameState.wickets}`);
            }
            if (vrBallsText) {
                vrBallsText.setAttribute('value', `Balls: ${GameState.ballsFaced}`);
            }
        }
        
        function showVRHUD(show) {
            const elements = ['vr-scoreboard', 'vr-score-text', 'vr-balls-text', 'vr-shot-text'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('visible', show);
            });
        }
        
        function hideBall() {
            const ball = document.getElementById('cricket-ball');
            if (ball) {
                ball.setAttribute('visible', 'false');
                ball.setAttribute('position', '0 1.5 -24');
            }
            
            // Clear trail
            const trailContainer = document.getElementById('ball-trail');
            if (trailContainer) {
                trailContainer.innerHTML = '';
            }
        }
        
        function showBall() {
            const ball = document.getElementById('cricket-ball');
            if (ball) {
                ball.setAttribute('visible', 'true');
            }
        }
        
        // ========================================================================
        // GAME CONTROL FUNCTIONS
        // ========================================================================
        
        function startGame() {
            // Get selected options
            const modeBtn = document.querySelector('[data-mode].active');
            const difficultyBtn = document.querySelector('[data-difficulty].active');
            const oversBtn = document.querySelector('[data-overs].active');
            
            GameState.mode = modeBtn ? modeBtn.dataset.mode : 'practice';
            GameState.difficulty = difficultyBtn ? difficultyBtn.dataset.difficulty : 'medium';
            GameState.totalOvers = oversBtn ? parseInt(oversBtn.dataset.overs) : 1;
            
            // Set target for target chase mode
            if (GameState.mode === 'target') {
                const baseTarget = GameState.totalOvers * 8; // ~8 runs per over average
                GameState.targetScore = baseTarget + Math.floor(Math.random() * (GameState.totalOvers * 4));
                document.getElementById('hud-target').textContent = GameState.targetScore;
                document.getElementById('hud-target-row').style.display = 'flex';
            } else {
                document.getElementById('hud-target-row').style.display = 'none';
            }
            
            // Reset state
            GameState.reset();
            
            // Update UI
            document.getElementById('menu-overlay').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            updateHUD();
            
            // Initialize audio on user interaction
            AudioSystem.init();
            
            // Reset bails
            PhysicsSystem.resetBails();
            
            // Show VR HUD
            showVRHUD(true);
            
            // Start first ball after delay
            setTimeout(() => {
                bowlBall();
            }, 2000);
        }
        
        function bowlBall() {
            if (!GameState.isPlaying || GameState.isPaused || GameState.isBallInPlay) return;
            
            // Reset physics system bounce counter
            PhysicsSystem.bounceCount = 0;
            
            // Generate delivery with proper physics
            const delivery = BowlingSystem.generateDelivery();
            
            console.log('==========================================');
            console.log('üèè BOWLING DELIVERY');
            console.log('==========================================');
            console.log(`Type: ${delivery.type}, Line: ${delivery.line}`);
            console.log(`Speed: ${delivery.speedKmh.toFixed(1)} km/h (${delivery.speed.toFixed(1)} m/s)`);
            console.log(`Start Position: (${delivery.startPos.x.toFixed(2)}, ${delivery.startPos.y.toFixed(2)}, ${delivery.startPos.z.toFixed(2)})`);
            console.log(`Velocity: (${delivery.velocity.x.toFixed(2)}, ${delivery.velocity.y.toFixed(2)}, ${delivery.velocity.z.toFixed(2)})`);
            if (delivery.bounceZ !== null) {
                console.log(`Expected bounce at z: ${delivery.bounceZ.toFixed(2)}`);
            }
            console.log('==========================================');
            
            // Set ball initial state
            GameState.ballPosition = {
                x: delivery.startPos.x,
                y: delivery.startPos.y,
                z: delivery.startPos.z
            };
            GameState.ballVelocity = {
                x: delivery.velocity.x,
                y: delivery.velocity.y,
                z: delivery.velocity.z
            };
            GameState.ballHasBouncedOnPitch = false;
            GameState.ballHitByBat = false;
            GameState.isBallInPlay = true;
            GameState.isReadyForBall = false;
            
            // Show ball at starting position
            showBall();
            const ball = document.getElementById('cricket-ball');
            if (ball) {
                ball.setAttribute('position', `${delivery.startPos.x} ${delivery.startPos.y} ${delivery.startPos.z}`);
            }
            
            // Update ball speed display
            updateBallSpeedDisplay(delivery.speedKmh);
            
            // Animate bowler
            animateBowler();
        }
        
        // Display ball speed in km/h
        function updateBallSpeedDisplay(speedKmh) {
            let speedDisplay = document.getElementById('ball-speed-display');
            if (!speedDisplay) {
                // Create speed display if it doesn't exist
                speedDisplay = document.createElement('div');
                speedDisplay.id = 'ball-speed-display';
                speedDisplay.innerHTML = `
                    <div class="speed-value">${speedKmh.toFixed(0)}</div>
                    <div class="speed-unit">km/h</div>
                `;
                document.body.appendChild(speedDisplay);
            } else {
                speedDisplay.querySelector('.speed-value').textContent = speedKmh.toFixed(0);
                speedDisplay.classList.remove('hidden');
            }
            
            // Hide after 2 seconds
            setTimeout(() => {
                if (speedDisplay) speedDisplay.classList.add('hidden');
            }, 2000);
        }
        
        function animateBowler() {
            const bowlerArm = document.getElementById('bowler-arm-right');
            if (bowlerArm) {
                bowlerArm.setAttribute('animation', {
                    property: 'rotation',
                    from: '0 0 -30',
                    to: '-180 0 -30',
                    dur: 300,
                    easing: 'easeInQuad'
                });
                
                setTimeout(() => {
                    bowlerArm.setAttribute('rotation', '0 0 -30');
                    bowlerArm.removeAttribute('animation');
                }, 500);
            }
        }
        
        function pauseGame() {
            if (!GameState.isPlaying || GameState.isGameOver) return;
            
            GameState.isPaused = true;
            document.getElementById('pause-menu').classList.remove('hidden');
        }
        
        function resumeGame() {
            GameState.isPaused = false;
            document.getElementById('pause-menu').classList.add('hidden');
        }
        
        function restartGame() {
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            
            // Reset and start
            GameState.reset();
            PhysicsSystem.resetBails();
            hideBall();
            updateHUD();
            
            setTimeout(() => {
                bowlBall();
            }, 1500);
        }
        
        function quitToMenu() {
            GameState.isPlaying = false;
            GameState.isPaused = false;
            
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game-hud').classList.add('hidden');
            document.getElementById('menu-overlay').classList.remove('hidden');
            
            showVRHUD(false);
            hideBall();
            PhysicsSystem.resetBails();
        }
        
        function endGame() {
            GameState.isPlaying = false;
            GameState.isGameOver = true;
            
            // Determine game over message
            let title = 'INNINGS OVER';
            if (GameState.mode === 'target') {
                if (GameState.runs >= GameState.targetScore) {
                    title = 'üéâ TARGET ACHIEVED!';
                } else {
                    title = 'üòî TARGET MISSED';
                }
            } else if (GameState.mode === 'survival' && GameState.wickets > 0) {
                title = 'OUT!';
            }
            
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('final-score').textContent = GameState.runs;
            document.getElementById('final-balls').textContent = GameState.ballsFaced;
            document.getElementById('final-fours').textContent = GameState.fours;
            document.getElementById('final-sixes').textContent = GameState.sixes;
            document.getElementById('final-sr').textContent = GameState.getStrikeRate();
            document.getElementById('final-best').textContent = GameState.bestShot || 'N/A';
            
            // Update high score
            if (GameState.runs > GameState.highScore) {
                GameState.highScore = GameState.runs;
                localStorage.setItem('cricketHighScore', GameState.runs);
            }
            
            document.getElementById('game-over').classList.remove('hidden');
        }
        
        // ========================================================================
        // GAME LOOP
        // ========================================================================
        
        let lastTime = 0;
        
        function gameLoop(currentTime) {
            requestAnimationFrame(gameLoop);
            
            if (!GameState.isPlaying || GameState.isPaused) return;
            
            const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;
            
            // Update physics
            PhysicsSystem.updateBall(deltaTime);
            
            // Check bat collision
            BattingSystem.checkCollision();
        }
        
        // ========================================================================
        // EVENT LISTENERS & INITIALIZATION
        // ========================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Menu button selection
            document.querySelectorAll('.menu-btn[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            document.querySelectorAll('.menu-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-difficulty]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            document.querySelectorAll('.menu-btn[data-overs]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-overs]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Game control buttons
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('resume-btn').addEventListener('click', resumeGame);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            document.getElementById('quit-btn').addEventListener('click', quitToMenu);
            document.getElementById('play-again-btn').addEventListener('click', restartGame);
            document.getElementById('menu-btn').addEventListener('click', quitToMenu);
            
            // Keyboard controls (for testing)
            document.addEventListener('keydown', function(e) {
                // Escape: Pause/Resume
                if (e.key === 'Escape') {
                    if (GameState.isPaused) {
                        resumeGame();
                    } else if (GameState.isPlaying) {
                        pauseGame();
                    }
                }
                
                // Spacebar: Bowl next ball (when ready)
                if (e.key === ' ' && GameState.isPlaying && !GameState.isBallInPlay) {
                    e.preventDefault();
                    bowlBall();
                }
                
                // D key: Toggle debug mode
                if (e.key === 'd' || e.key === 'D') {
                    CONFIG.debugMode = !CONFIG.debugMode;
                    console.log(`üîß Debug mode: ${CONFIG.debugMode ? 'ON' : 'OFF'}`);
                    
                    // Show/hide debug panel
                    let debugPanel = document.getElementById('debug-panel');
                    if (CONFIG.debugMode) {
                        if (!debugPanel) {
                            debugPanel = document.createElement('div');
                            debugPanel.id = 'debug-panel';
                            document.body.appendChild(debugPanel);
                        }
                        debugPanel.classList.remove('hidden');
                        updateDebugPanel();
                    } else if (debugPanel) {
                        debugPanel.classList.add('hidden');
                    }
                }
                
                // B key: Force bowl a ball (for testing)
                if ((e.key === 'b' || e.key === 'B') && GameState.isPlaying) {
                    console.log('üîß Force bowling ball...');
                    GameState.isBallInPlay = false;
                    bowlBall();
                }
            });
            
            // Debug panel update
            function updateDebugPanel() {
                if (!CONFIG.debugMode) return;
                
                const panel = document.getElementById('debug-panel');
                if (!panel) return;
                
                const ball = GameState.ballPosition;
                const vel = GameState.ballVelocity;
                const speed = Math.sqrt(vel.x*vel.x + vel.y*vel.y + vel.z*vel.z);
                
                panel.innerHTML = `
                    <strong>DEBUG MODE</strong><br>
                    Ball Position: (${ball.x.toFixed(2)}, ${ball.y.toFixed(2)}, ${ball.z.toFixed(2)})<br>
                    Ball Velocity: (${vel.x.toFixed(2)}, ${vel.y.toFixed(2)}, ${vel.z.toFixed(2)})<br>
                    Speed: ${(speed * 3.6).toFixed(1)} km/h<br>
                    In Play: ${GameState.isBallInPlay}<br>
                    Bounced: ${GameState.ballHasBouncedOnPitch}<br>
                    Delivery: ${GameState.currentDeliveryType}<br>
                    Line: ${GameState.currentLine}
                `;
            }
            
            // Update debug panel periodically
            setInterval(updateDebugPanel, 100);
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        });
        
        // A-Frame scene initialization
        const scene = document.querySelector('a-scene');
        if (scene) {
            scene.addEventListener('loaded', function() {
                console.log('VR Cricket Scene Loaded!');
                
                // Set up controller tracking
                const rightHand = document.getElementById('right-hand');
                
                if (rightHand) {
                    // Track controller movement
                    rightHand.addEventListener('controllerconnected', function() {
                        console.log('Right controller connected');
                    });
                    
                    // Grip button for pause
                    rightHand.addEventListener('gripdown', function() {
                        if (GameState.isPlaying && !GameState.isPaused) {
                            pauseGame();
                        }
                    });
                    
                    // Track bat position
                    setInterval(function() {
                        if (rightHand.object3D) {
                            const pos = rightHand.object3D.position;
                            const rot = rightHand.object3D.rotation;
                            BattingSystem.updateBat(
                                { x: pos.x, y: pos.y, z: pos.z },
                                { x: rot.x, y: rot.y, z: rot.z }
                            );
                        }
                    }, 16); // ~60fps tracking
                }
                
                const leftHand = document.getElementById('left-hand');
                if (leftHand) {
                    // Trigger for ready/next ball
                    leftHand.addEventListener('triggerdown', function() {
                        if (GameState.isPlaying && !GameState.isPaused && GameState.isReadyForBall) {
                            bowlBall();
                        }
                    });
                    
                    // Grip for reset position
                    leftHand.addEventListener('gripdown', function() {
                        const rig = document.getElementById('rig');
                        if (rig) {
                            rig.setAttribute('position', '0 0 0');
                        }
                    });
                }
            });
            
            // VR mode events
            scene.addEventListener('enter-vr', function() {
                console.log('Entered VR mode');
                showVRHUD(true);
            });
            
            scene.addEventListener('exit-vr', function() {
                console.log('Exited VR mode');
                showVRHUD(false);
            });
        }
        
        // Mouse/Touch controls for non-VR testing
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        document.addEventListener('mousedown', function(e) {
            if (e.target.tagName === 'CANVAS') {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging && GameState.isPlaying) {
                const deltaX = (e.clientX - lastMouseX) * 0.01;
                const deltaY = (e.clientY - lastMouseY) * 0.01;
                
                // Simulate bat movement for testing
                BattingSystem.updateBat(
                    { 
                        x: GameState.batPosition.x + deltaX, 
                        y: GameState.batPosition.y - deltaY, 
                        z: GameState.batPosition.z 
                    },
                    GameState.batRotation
                );
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
        
        // Click to hit for desktop testing
        // Simulates a bat swing when ball is in the hitting zone
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'CANVAS' && GameState.isBallInPlay && !GameState.ballHitByBat) {
                // Ball is in hitting zone when z is between -3 and 2
                const ball = GameState.ballPosition;
                console.log(`üñ±Ô∏è Click detected. Ball at z=${ball.z.toFixed(2)}`);
                
                if (ball.z > -3 && ball.z < 2) {
                    console.log('üèè Ball in hitting zone! Simulating hit...');
                    
                    // Simulate a hit for desktop testing
                    const simulatedBatPos = { 
                        x: ball.x + (Math.random() - 0.5) * 0.1, 
                        y: ball.y + (Math.random() - 0.5) * 0.1, 
                        z: ball.z 
                    };
                    
                    // Create simulated bat velocity (as if swinging)
                    const swingDirection = Math.random() > 0.5 ? 1 : -1;  // Off side or leg side
                    BattingSystem.velocityHistory = [
                        { 
                            x: swingDirection * (3 + Math.random() * 5),  // Horizontal swing
                            y: 2 + Math.random() * 3,                      // Slight upward motion
                            z: -6 - Math.random() * 6                      // Forward momentum
                        }
                    ];
                    
                    BattingSystem.handleHit(simulatedBatPos, 0.1);
                } else {
                    console.log(`‚ö†Ô∏è Ball not in hitting zone (z=${ball.z.toFixed(2)}). Zone is -3 to 2.`);
                }
            }
        });
        
        // Log help message on startup
        console.log('==========================================');
        console.log('üèè VR CRICKET PRO - Debug Controls');
        console.log('==========================================');
        console.log('SPACEBAR: Bowl next ball');
        console.log('B: Force bowl (bypass checks)');
        console.log('D: Toggle debug mode');
        console.log('ESC: Pause/Resume');
        console.log('CLICK on canvas: Simulate bat hit');
        console.log('==========================================');
        
    })();
    </script>
</body>
</html>
