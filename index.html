<!--
================================================================================
VR CRICKET PRO - Meta Quest 2 Photorealistic Edition
================================================================================

PHYSICS ENGINE DOCUMENTATION:

Ball Trajectory Calculation:
----------------------------
Using kinematic equations for projectile motion:
- Distance to travel: Œîz = z_target - z_start = 24-25m
- Time of flight: t = Œîz / v_horizontal
- Vertical velocity: vy = (y_target - y_start)/t + 0.5*g*t (compensates for gravity)
- Lateral velocity: vx = Œîx / t

Speed Conversions:
- Easy: 60-80 km/h = 16.7-22.2 m/s
- Medium: 100-130 km/h = 27.8-36.1 m/s  
- Hard: 140-160 km/h = 38.9-44.4 m/s

Pitch Bounce Physics:
- Coefficient of Restitution: 0.4-0.6 (cricket pitch)
- Bounce angle affected by pitch roughness and ball spin
- Seam position affects lateral movement after bounce

Magnus Effect (Spin):
- F_magnus = 0.5 * Cl * œÅ * A * v¬≤ (perpendicular to velocity and spin axis)
- Creates curve in ball trajectory
- Off-spin: ball curves from off to leg
- Leg-spin: ball curves from leg to off

Swing Physics:
- Differential air pressure due to ball seam orientation
- Inswing: seam angled towards batsman, ball curves in
- Outswing: seam angled away, ball curves away
- Reverse swing occurs with old ball (rough on one side)

CONTROLS:
- Right Controller: Cricket bat (swing to hit)
- Left Trigger: Ready for next ball
- Right Grip: Pause game
- A/X Button: Change stance

Enjoy photorealistic VR cricket! üèè
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Cricket Pro - Quest 2 Photorealistic Edition</title>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- A-Frame Extras for better physics -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #0a1f0a 0%, #1a3a1a 100%);
        }
        
        /* Main Menu Overlay - Enhanced */
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 31, 10, 0.97) 0%, rgba(26, 58, 26, 0.97) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #menu-overlay.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7), 0 0 30px rgba(255,215,0,0.3);
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .menu-subtitle {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.8;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .menu-section {
            margin: 0.8rem 0;
            text-align: center;
        }
        
        .menu-section h3 {
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .menu-btn {
            padding: 10px 20px;
            font-size: 0.95rem;
            border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 100px;
            backdrop-filter: blur(5px);
        }
        
        .menu-btn:hover, .menu-btn.active {
            background: rgba(255,215,0,0.9);
            color: #0a1f0a;
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.3);
        }
        
        .menu-btn.primary {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border-color: #ffd700;
            color: #0a1f0a;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 15px 50px;
            box-shadow: 0 5px 30px rgba(255,215,0,0.4);
        }
        
        .menu-btn.primary:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 10px 40px rgba(255,215,0,0.5);
        }
        
        .instructions {
            margin-top: 1.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            max-width: 500px;
            text-align: left;
            font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .instructions h4 {
            margin-bottom: 0.5rem;
            color: #ffd700;
        }
        
        /* Enhanced In-Game HUD */
        #game-hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,20,0.85));
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 100;
            min-width: 220px;
            border: 1px solid rgba(255,215,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        #game-hud.hidden {
            display: none;
        }
        
        .hud-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            padding: 2px 0;
        }
        
        .hud-label {
            opacity: 0.7;
        }
        
        .hud-value {
            font-weight: bold;
            color: #ffd700;
        }
        
        .hud-score {
            font-size: 2.5rem;
            text-align: center;
            border-bottom: 2px solid rgba(255,215,0,0.3);
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        
        /* Ball Speed Display */
        #ball-speed-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(20,20,20,0.85));
            color: #00ff88;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 100;
            border: 1px solid rgba(0,255,136,0.3);
            text-align: center;
            min-width: 120px;
        }
        
        #ball-speed-display.hidden {
            display: none;
        }
        
        #ball-speed-display .speed-value {
            font-size: 2rem;
        }
        
        #ball-speed-display .speed-unit {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        /* Timing Indicator */
        #timing-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        #timing-indicator.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        #timing-indicator.perfect {
            color: #00ff88;
            text-shadow: 0 0 30px rgba(0,255,136,0.8);
        }
        
        #timing-indicator.good {
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255,215,0,0.8);
        }
        
        #timing-indicator.poor {
            color: #ff6b6b;
            text-shadow: 0 0 30px rgba(255,107,107,0.8);
        }
        
        /* Shot Feedback - Enhanced */
        #shot-feedback {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.9), 0 0 40px currentColor;
            z-index: 200;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s, transform 0.4s;
        }
        
        #shot-feedback.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        #shot-feedback.four {
            color: #00ff88;
        }
        
        #shot-feedback.six {
            color: #ffd700;
            animation: pulse-gold 0.5s ease-in-out;
        }
        
        #shot-feedback.out {
            color: #ff4444;
        }
        
        #shot-feedback.runs {
            color: #4fc3f7;
        }
        
        @keyframes pulse-gold {
            0%, 100% { transform: translate(-50%, -50%) scale(1.1); }
            50% { transform: translate(-50%, -50%) scale(1.3); }
        }
        
        /* Wagon Wheel Container */
        #wagon-wheel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 100;
        }
        
        #wagon-wheel.hidden {
            display: none;
        }
        
        #wagon-wheel-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Pause Menu - Enhanced */
        #pause-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 500;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        #pause-menu.hidden {
            display: none;
        }
        
        #pause-menu h2 {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #ffd700;
        }
        
        /* Game Over Screen - Enhanced */
        #game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,10,0,0.95));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 600;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        #game-over.hidden {
            display: none;
        }
        
        #game-over h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 1.5rem 0;
            min-width: 400px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.08);
            padding: 20px 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,215,0,0.2);
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
            border-color: rgba(255,215,0,0.5);
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Debug Panel */
        #debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            z-index: 100;
            max-width: 300px;
            border: 1px solid #00ff00;
        }
        
        #debug-panel.hidden {
            display: none;
        }
        
        /* VR Button styling */
        .a-enter-vr-button {
            background: linear-gradient(135deg, #ffd700, #ff8c00) !important;
            color: #0a1f0a !important;
            font-weight: bold !important;
            border-radius: 8px !important;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a1f0a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="menu-overlay">
        <div class="menu-title">üèè VR CRICKET</div>
        <div class="menu-subtitle">Meta Quest 2 Edition</div>
        
        <div class="menu-section">
            <h3>Game Mode</h3>
            <div class="btn-group">
                <button class="menu-btn active" data-mode="practice">Practice</button>
                <button class="menu-btn" data-mode="challenge">Challenge</button>
                <button class="menu-btn" data-mode="survival">Survival</button>
                <button class="menu-btn" data-mode="target">Target Chase</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Difficulty</h3>
            <div class="btn-group">
                <button class="menu-btn" data-difficulty="easy">Easy</button>
                <button class="menu-btn active" data-difficulty="medium">Medium</button>
                <button class="menu-btn" data-difficulty="hard">Hard</button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Overs (Challenge/Target Mode)</h3>
            <div class="btn-group">
                <button class="menu-btn active" data-overs="1">1 Over</button>
                <button class="menu-btn" data-overs="2">2 Overs</button>
                <button class="menu-btn" data-overs="4">4 Overs</button>
            </div>
        </div>
        
        <div class="menu-section" style="margin-top: 2rem;">
            <button class="menu-btn primary" id="start-btn">‚ñ∂ START GAME</button>
        </div>
        
        <div class="instructions">
            <h4>üéÆ Controls:</h4>
            <p>‚Ä¢ <strong>Right Controller</strong> - Cricket bat (swing to hit)</p>
            <p>‚Ä¢ <strong>Left Trigger</strong> - Ready for next ball</p>
            <p>‚Ä¢ <strong>Right Grip</strong> - Pause game</p>
            <p>‚Ä¢ <strong>Left Grip</strong> - Reset position</p>
            <p style="margin-top: 10px; opacity: 0.7;">Click the VR button to enter immersive mode!</p>
        </div>
    </div>
    
    <!-- In-Game HUD -->
    <div id="game-hud" class="hidden">
        <div class="hud-score">
            <span id="hud-runs">0</span>/<span id="hud-wickets">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Balls:</span>
            <span class="hud-value" id="hud-balls">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Fours:</span>
            <span class="hud-value" id="hud-fours">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Sixes:</span>
            <span class="hud-value" id="hud-sixes">0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Strike Rate:</span>
            <span class="hud-value" id="hud-sr">0.00</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Last Shot:</span>
            <span class="hud-value" id="hud-shot">-</span>
        </div>
        <div class="hud-row" id="hud-target-row" style="display: none;">
            <span class="hud-label">Target:</span>
            <span class="hud-value" id="hud-target">0</span>
        </div>
    </div>
    
    <!-- Shot Feedback -->
    <div id="shot-feedback"></div>
    
    <!-- Timing Indicator -->
    <div id="timing-indicator"></div>
    
    <!-- Ball Speed Display -->
    <div id="ball-speed-display" class="hidden">
        <div class="speed-value">0</div>
        <div class="speed-unit">km/h</div>
    </div>
    
    <!-- Pause Menu -->
    <div id="pause-menu" class="hidden">
        <h2>‚è∏ PAUSED</h2>
        <div class="btn-group" style="flex-direction: column;">
            <button class="menu-btn" id="resume-btn">‚ñ∂ Resume</button>
            <button class="menu-btn" id="restart-btn">üîÑ Restart</button>
            <button class="menu-btn" id="quit-btn">üè† Main Menu</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="game-over" class="hidden">
        <h2 id="game-over-title">INNINGS OVER</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="final-score">0</div>
                <div class="stat-label">Runs Scored</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-balls">0</div>
                <div class="stat-label">Balls Faced</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-fours">0</div>
                <div class="stat-label">Fours</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-sixes">0</div>
                <div class="stat-label">Sixes</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-sr">0.00</div>
                <div class="stat-label">Strike Rate</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="final-best">-</div>
                <div class="stat-label">Best Shot</div>
            </div>
        </div>
        <div class="btn-group" style="margin-top: 1rem;">
            <button class="menu-btn primary" id="play-again-btn">üèè Play Again</button>
            <button class="menu-btn" id="menu-btn">üè† Main Menu</button>
        </div>
    </div>
    
    <!-- A-Frame Scene -->
    <a-scene 
        id="cricket-scene"
        vr-mode-ui="enabled: true"
        renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true; sortObjects: true"
        shadow="type: pcfsoft; autoUpdate: true"
        loading-screen="dotsColor: #ffd700; backgroundColor: #0a1f0a">
        
        <!-- ================================================================
             ASSETS - Preload all textures and materials for better performance
             Using procedurally generated textures via canvas for portability
        ================================================================= -->
        <a-assets timeout="30000">
            <!-- Sounds -->
            <audio id="bat-hit-sound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=" preload="auto"></audio>
            
            <!-- Procedural Textures will be created via JavaScript -->
            <canvas id="grass-texture-canvas" width="512" height="512"></canvas>
            <canvas id="pitch-texture-canvas" width="512" height="256"></canvas>
            <canvas id="wood-texture-canvas" width="256" height="256"></canvas>
            <canvas id="leather-texture-canvas" width="256" height="256"></canvas>
            <canvas id="crowd-texture-canvas" width="512" height="256"></canvas>
            <canvas id="sky-gradient-canvas" width="512" height="512"></canvas>
        </a-assets>
        
        <!-- ================================================================
             SKY DOME - Realistic gradient sky with clouds
             Uses gradient from horizon to zenith for depth
        ================================================================= -->
        <a-sky id="sky" 
               material="shader: flat; side: back"
               theta-length="180"
               radius="500">
        </a-sky>
        
        <!-- Cloud layer - subtle white patches -->
        <a-entity id="clouds">
            <a-sphere position="-100 80 -200" radius="30" 
                      material="color: #ffffff; opacity: 0.4; transparent: true; shader: flat">
            </a-sphere>
            <a-sphere position="50 90 -180" radius="25" 
                      material="color: #ffffff; opacity: 0.35; transparent: true; shader: flat">
            </a-sphere>
            <a-sphere position="-50 85 -150" radius="35" 
                      material="color: #f8f8ff; opacity: 0.3; transparent: true; shader: flat">
            </a-sphere>
            <a-sphere position="120 75 -220" radius="28" 
                      material="color: #ffffff; opacity: 0.38; transparent: true; shader: flat">
            </a-sphere>
        </a-entity>
        
        <!-- ================================================================
             LIGHTING SYSTEM - Realistic stadium lighting
             Main sun + fill lights + ambient for depth
        ================================================================= -->
        
        <!-- Main Sun/Directional Light - Primary shadow caster -->
        <a-entity id="sun-light"
            light="type: directional; 
                   color: #FFF8E7; 
                   intensity: 1.5; 
                   castShadow: true;
                   shadowMapWidth: 2048;
                   shadowMapHeight: 2048;
                   shadowCameraLeft: -50;
                   shadowCameraRight: 50;
                   shadowCameraTop: 50;
                   shadowCameraBottom: -50;
                   shadowCameraNear: 1;
                   shadowCameraFar: 200;
                   shadowBias: -0.001"
            position="30 60 20">
        </a-entity>
        
        <!-- Fill Light - Softens shadows -->
        <a-entity 
            light="type: directional; color: #B4D7FF; intensity: 0.4"
            position="-30 40 -20">
        </a-entity>
        
        <!-- Ambient Light - Base illumination -->
        <a-entity light="type: ambient; color: #87CEEB; intensity: 0.35"></a-entity>
        
        <!-- Hemisphere Light - Sky/ground color blend -->
        <a-entity light="type: hemisphere; color: #87CEEB; groundColor: #3d5c3d; intensity: 0.4"></a-entity>
        
        <!-- ================================================================
             STADIUM FLOODLIGHTS - 4 towers around the ground
             Each tower has multiple light sources
        ================================================================= -->
        <a-entity id="floodlights">
            <!-- Tower 1 - North East -->
            <a-entity id="floodlight-tower-1" position="55 0 -60">
                <a-cylinder position="0 20 0" radius="1.5" height="40" 
                            material="color: #444; metalness: 0.8; roughness: 0.3" shadow="cast: true"></a-cylinder>
                <a-box position="0 42 0" width="8" height="3" depth="4" 
                       material="color: #333; metalness: 0.7"></a-box>
                <!-- Light panels (emissive for glow effect) -->
                <a-box position="0 42 -2.5" width="7" height="2" depth="0.3" 
                       material="color: #FFFFEE; emissive: #FFFFAA; emissiveIntensity: 0.5; shader: flat"></a-box>
                <a-entity light="type: spot; color: #FFFEF0; intensity: 0.8; angle: 60; penumbra: 0.3; distance: 150"
                          position="0 42 -3" rotation="-45 180 0"></a-entity>
            </a-entity>
            
            <!-- Tower 2 - North West -->
            <a-entity id="floodlight-tower-2" position="-55 0 -60">
                <a-cylinder position="0 20 0" radius="1.5" height="40" 
                            material="color: #444; metalness: 0.8; roughness: 0.3" shadow="cast: true"></a-cylinder>
                <a-box position="0 42 0" width="8" height="3" depth="4" 
                       material="color: #333; metalness: 0.7"></a-box>
                <a-box position="0 42 -2.5" width="7" height="2" depth="0.3" 
                       material="color: #FFFFEE; emissive: #FFFFAA; emissiveIntensity: 0.5; shader: flat"></a-box>
                <a-entity light="type: spot; color: #FFFEF0; intensity: 0.8; angle: 60; penumbra: 0.3; distance: 150"
                          position="0 42 -3" rotation="-45 180 0"></a-entity>
            </a-entity>
            
            <!-- Tower 3 - South East -->
            <a-entity id="floodlight-tower-3" position="55 0 40">
                <a-cylinder position="0 20 0" radius="1.5" height="40" 
                            material="color: #444; metalness: 0.8; roughness: 0.3" shadow="cast: true"></a-cylinder>
                <a-box position="0 42 0" width="8" height="3" depth="4" 
                       material="color: #333; metalness: 0.7"></a-box>
                <a-box position="0 42 2.5" width="7" height="2" depth="0.3" 
                       material="color: #FFFFEE; emissive: #FFFFAA; emissiveIntensity: 0.5; shader: flat"></a-box>
                <a-entity light="type: spot; color: #FFFEF0; intensity: 0.8; angle: 60; penumbra: 0.3; distance: 150"
                          position="0 42 3" rotation="-45 0 0"></a-entity>
            </a-entity>
            
            <!-- Tower 4 - South West -->
            <a-entity id="floodlight-tower-4" position="-55 0 40">
                <a-cylinder position="0 20 0" radius="1.5" height="40" 
                            material="color: #444; metalness: 0.8; roughness: 0.3" shadow="cast: true"></a-cylinder>
                <a-box position="0 42 0" width="8" height="3" depth="4" 
                       material="color: #333; metalness: 0.7"></a-box>
                <a-box position="0 42 2.5" width="7" height="2" depth="0.3" 
                       material="color: #FFFFEE; emissive: #FFFFAA; emissiveIntensity: 0.5; shader: flat"></a-box>
                <a-entity light="type: spot; color: #FFFEF0; intensity: 0.8; angle: 60; penumbra: 0.3; distance: 150"
                          position="0 42 3" rotation="-45 0 0"></a-entity>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             STADIUM ENVIRONMENT - Ground, Pitch, Stands, Boundary
        ================================================================= -->
        <a-entity id="stadium">
            
            <!-- MAIN OUTFIELD - Realistic grass with texture -->
            <a-cylinder 
                id="outfield"
                position="0 -0.05 -11" 
                radius="75" 
                height="0.1"
                segments-radial="64"
                material="color: #2d5a27; roughness: 0.9; metalness: 0"
                shadow="receive: true">
            </a-cylinder>
            
            <!-- Grass detail layer - slightly raised for depth -->
            <a-cylinder
                id="grass-detail"
                position="0 -0.02 -11"
                radius="74.5"
                height="0.04"
                segments-radial="64"
                material="color: #3a7233; roughness: 0.85; metalness: 0; transparent: true; opacity: 0.7"
                shadow="receive: true">
            </a-cylinder>
            
            <!-- 30-yard circle marking -->
            <a-torus 
                id="thirty-yard-circle"
                position="0 0.02 -11" 
                radius="27.4" 
                radius-tubular="0.08" 
                material="color: #ffffff; roughness: 0.5"
                rotation="90 0 0"
                segments-tubular="100">
            </a-torus>
            
            <!-- ============================================================
                 CRICKET PITCH - Brown with worn areas and crease markings
            ============================================================= -->
            <a-entity id="pitch-area">
                <!-- Main pitch surface -->
                <a-box 
                    id="pitch"
                    position="0 0.01 -11" 
                    width="3.05" 
                    height="0.03" 
                    depth="22.5" 
                    material="color: #C4A35A; roughness: 0.95; metalness: 0"
                    shadow="receive: true; cast: true">
                </a-box>
                
                <!-- Worn area - batting crease (darker, more used) -->
                <a-box 
                    position="0 0.015 -0.5" 
                    width="2.5" 
                    height="0.01" 
                    depth="2" 
                    material="color: #A08040; roughness: 1; metalness: 0"
                    shadow="receive: true">
                </a-box>
                
                <!-- Worn area - bowler's landing spot -->
                <a-box 
                    position="0 0.015 -18" 
                    width="1.5" 
                    height="0.01" 
                    depth="2.5" 
                    material="color: #A58050; roughness: 1; metalness: 0"
                    shadow="receive: true">
                </a-box>
                
                <!-- Pitch cracks (subtle dark lines) -->
                <a-box position="0.3 0.018 -10" width="0.02" height="0.005" depth="4" 
                       material="color: #5a4a2a; roughness: 1"></a-box>
                <a-box position="-0.4 0.018 -12" width="0.015" height="0.005" depth="3" 
                       material="color: #5a4a2a; roughness: 1"></a-box>
                <a-box position="0.1 0.018 -8" width="0.02" height="0.005" depth="2.5" 
                       material="color: #5a4a2a; roughness: 1"></a-box>
                
                <!-- ========== CREASE MARKINGS ========== -->
                <!-- Batting crease (popping crease) -->
                <a-box position="0 0.025 0" width="2.64" height="0.01" depth="0.05" 
                       material="color: #ffffff; roughness: 0.3" shadow="cast: true"></a-box>
                
                <!-- Return creases - batting end -->
                <a-box position="1.32 0.025 -0.6" width="0.05" height="0.01" depth="1.3" 
                       material="color: #ffffff; roughness: 0.3"></a-box>
                <a-box position="-1.32 0.025 -0.6" width="0.05" height="0.01" depth="1.3" 
                       material="color: #ffffff; roughness: 0.3"></a-box>
                
                <!-- Bowling crease -->
                <a-box position="0 0.025 -22" width="2.64" height="0.01" depth="0.05" 
                       material="color: #ffffff; roughness: 0.3"></a-box>
                
                <!-- Return creases - bowling end -->
                <a-box position="1.32 0.025 -21.4" width="0.05" height="0.01" depth="1.3" 
                       material="color: #ffffff; roughness: 0.3"></a-box>
                <a-box position="-1.32 0.025 -21.4" width="0.05" height="0.01" depth="1.3" 
                       material="color: #ffffff; roughness: 0.3"></a-box>
            </a-entity>
            
            <!-- ============================================================
                 BOUNDARY ROPE & ADVERTISING BOARDS
            ============================================================= -->
            <!-- Boundary rope -->
            <a-torus 
                id="boundary-rope"
                position="0 0.08 -11" 
                radius="68" 
                radius-tubular="0.12" 
                material="color: #ffffff; roughness: 0.4"
                rotation="90 0 0"
                segments-tubular="120"
                segments-radial="8">
            </a-torus>
            
            <!-- Advertising boards around boundary -->
            <a-entity id="advertising-boards">
                <!-- Board segments around the boundary (every 30 degrees) -->
                <a-box position="0 0.6 -79" width="15" height="1.2" depth="0.3" 
                       material="color: #1a4d8f; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                <a-text position="0 0.6 -78.7" value="VR CRICKET" align="center" color="#ffffff" width="12"></a-text>
                
                <a-box position="40 0.6 -68" width="15" height="1.2" depth="0.3" rotation="0 -30 0"
                       material="color: #8f1a1a; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                <a-text position="40.2 0.6 -67.7" value="QUEST 2" align="center" color="#ffffff" width="10" rotation="0 -30 0"></a-text>
                
                <a-box position="68 0.6 -40" width="15" height="1.2" depth="0.3" rotation="0 -60 0"
                       material="color: #1a8f4d; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                
                <a-box position="-40 0.6 -68" width="15" height="1.2" depth="0.3" rotation="0 30 0"
                       material="color: #8f6b1a; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                
                <a-box position="-68 0.6 -40" width="15" height="1.2" depth="0.3" rotation="0 60 0"
                       material="color: #4d1a8f; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                
                <!-- Behind batsman boards -->
                <a-box position="40 0.6 50" width="15" height="1.2" depth="0.3" rotation="0 30 0"
                       material="color: #1a4d8f; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
                       
                <a-box position="-40 0.6 50" width="15" height="1.2" depth="0.3" rotation="0 -30 0"
                       material="color: #8f1a4d; roughness: 0.3" shadow="cast: true; receive: true"></a-box>
            </a-entity>
            
            <!-- ============================================================
                 SIGHT SCREEN - Behind bowler
            ============================================================= -->
            <a-box id="sight-screen"
                   position="0 6 -85" 
                   width="20" height="12" depth="0.5"
                   material="color: #f5f5f5; roughness: 0.2; metalness: 0.1"
                   shadow="cast: true; receive: true">
            </a-box>
            
            <!-- ============================================================
                 STADIUM STANDS - Tiered seating with crowd
            ============================================================= -->
            <a-entity id="stadium-stands">
                <!-- Main stand - behind bowler -->
                <a-entity id="stand-north" position="0 0 -90">
                    <!-- Lower tier -->
                    <a-box position="0 4 0" width="100" height="8" depth="15" 
                           material="color: #4a4a4a; roughness: 0.8" shadow="receive: true"></a-box>
                    <!-- Upper tier -->
                    <a-box position="0 12 -5" width="100" height="8" depth="15" 
                           material="color: #3a3a3a; roughness: 0.8" shadow="receive: true"></a-box>
                    <!-- Roof -->
                    <a-box position="0 18 -2" width="105" height="0.5" depth="25" 
                           material="color: #2a2a2a; roughness: 0.6" shadow="cast: true; receive: true"></a-box>
                    <!-- Crowd color blocks (simulating filled seats) -->
                    <a-box position="0 5 7" width="90" height="5" depth="0.5" 
                           material="color: #c9302c; roughness: 0.9"></a-box>
                    <a-box position="0 13 2" width="90" height="5" depth="0.5" 
                           material="color: #337ab7; roughness: 0.9"></a-box>
                </a-entity>
                
                <!-- Stand - behind batsman/keeper -->
                <a-entity id="stand-south" position="0 0 60">
                    <a-box position="0 4 0" width="80" height="8" depth="15" 
                           material="color: #4a4a4a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 12 5" width="80" height="8" depth="15" 
                           material="color: #3a3a3a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 18 2" width="85" height="0.5" depth="25" 
                           material="color: #2a2a2a; roughness: 0.6" shadow="cast: true"></a-box>
                    <!-- Crowd -->
                    <a-box position="0 5 -7" width="70" height="5" depth="0.5" 
                           material="color: #5cb85c; roughness: 0.9"></a-box>
                    <a-box position="0 13 -2" width="70" height="5" depth="0.5" 
                           material="color: #f0ad4e; roughness: 0.9"></a-box>
                </a-entity>
                
                <!-- East stand -->
                <a-entity id="stand-east" position="80 0 -11" rotation="0 -90 0">
                    <a-box position="0 4 0" width="80" height="8" depth="12" 
                           material="color: #4a4a4a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 12 -4" width="80" height="8" depth="12" 
                           material="color: #3a3a3a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 18 -2" width="85" height="0.5" depth="20" 
                           material="color: #2a2a2a; roughness: 0.6" shadow="cast: true"></a-box>
                    <a-box position="0 5 5" width="70" height="5" depth="0.5" 
                           material="color: #d9534f; roughness: 0.9"></a-box>
                </a-entity>
                
                <!-- West stand -->
                <a-entity id="stand-west" position="-80 0 -11" rotation="0 90 0">
                    <a-box position="0 4 0" width="80" height="8" depth="12" 
                           material="color: #4a4a4a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 12 -4" width="80" height="8" depth="12" 
                           material="color: #3a3a3a; roughness: 0.8" shadow="receive: true"></a-box>
                    <a-box position="0 18 -2" width="85" height="0.5" depth="20" 
                           material="color: #2a2a2a; roughness: 0.6" shadow="cast: true"></a-box>
                    <a-box position="0 5 5" width="70" height="5" depth="0.5" 
                           material="color: #5bc0de; roughness: 0.9"></a-box>
                </a-entity>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             STUMPS - BATSMAN END (with LED effect capability)
             Realistic wooden texture with proper cricket dimensions
        ================================================================= -->
        <a-entity id="batsman-stumps" position="0 0 0.5">
            <!-- Three Stumps - 28.5 inches (0.72m) tall, 1.125 inches diameter -->
            <!-- Off Stump -->
            <a-cylinder id="stump-off" position="-0.115 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7; metalness: 0"
                        shadow="cast: true; receive: true">
                <!-- LED glow ring (hidden by default, shown when hit) -->
                <a-torus class="led-ring" position="0 0.3 0" radius="0.016" radius-tubular="0.003" 
                         material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 0; shader: flat" 
                         rotation="90 0 0" visible="false"></a-torus>
            </a-cylinder>
            
            <!-- Middle Stump -->
            <a-cylinder id="stump-middle" position="0 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7; metalness: 0"
                        shadow="cast: true; receive: true">
                <a-torus class="led-ring" position="0 0.3 0" radius="0.016" radius-tubular="0.003" 
                         material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 0; shader: flat" 
                         rotation="90 0 0" visible="false"></a-torus>
            </a-cylinder>
            
            <!-- Leg Stump -->
            <a-cylinder id="stump-leg" position="0.115 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7; metalness: 0"
                        shadow="cast: true; receive: true">
                <a-torus class="led-ring" position="0 0.3 0" radius="0.016" radius-tubular="0.003" 
                         material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 0; shader: flat" 
                         rotation="90 0 0" visible="false"></a-torus>
            </a-cylinder>
            
            <!-- Bails - with grooves (sits on top of stumps) -->
            <a-entity id="bail-1" position="-0.0575 0.73 0">
                <a-cylinder radius="0.008" height="0.11" rotation="0 0 90"
                            material="color: #F5DEB3; roughness: 0.6"
                            shadow="cast: true"></a-cylinder>
                <!-- Bail groove details -->
                <a-sphere position="-0.04 0 0" radius="0.01" material="color: #E8D4A8"></a-sphere>
                <a-sphere position="0.04 0 0" radius="0.01" material="color: #E8D4A8"></a-sphere>
            </a-entity>
            
            <a-entity id="bail-2" position="0.0575 0.73 0">
                <a-cylinder radius="0.008" height="0.11" rotation="0 0 90"
                            material="color: #F5DEB3; roughness: 0.6"
                            shadow="cast: true"></a-cylinder>
                <a-sphere position="-0.04 0 0" radius="0.01" material="color: #E8D4A8"></a-sphere>
                <a-sphere position="0.04 0 0" radius="0.01" material="color: #E8D4A8"></a-sphere>
            </a-entity>
        </a-entity>
        
        <!-- STUMPS - BOWLER END -->
        <a-entity id="bowler-stumps" position="0 0 -22">
            <a-cylinder position="-0.115 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7" shadow="cast: true"></a-cylinder>
            <a-cylinder position="0 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7" shadow="cast: true"></a-cylinder>
            <a-cylinder position="0.115 0.36 0" radius="0.014" height="0.72" 
                        material="color: #DEB887; roughness: 0.7" shadow="cast: true"></a-cylinder>
            <!-- Bails -->
            <a-entity position="-0.0575 0.73 0">
                <a-cylinder radius="0.008" height="0.11" rotation="0 0 90"
                            material="color: #F5DEB3; roughness: 0.6" shadow="cast: true"></a-cylinder>
            </a-entity>
            <a-entity position="0.0575 0.73 0">
                <a-cylinder radius="0.008" height="0.11" rotation="0 0 90"
                            material="color: #F5DEB3; roughness: 0.6" shadow="cast: true"></a-cylinder>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             BOWLER - Detailed player model with proper proportions
        ================================================================= -->
        <a-entity id="bowler" position="0 0 -25">
            <!-- Legs (cricket whites) -->
            <a-entity id="bowler-legs">
                <!-- Right leg -->
                <a-cylinder position="0.12 0.35 0" radius="0.08" height="0.7" 
                            material="color: #f5f5f5; roughness: 0.8" shadow="cast: true"></a-cylinder>
                <!-- Left leg -->
                <a-cylinder position="-0.12 0.35 0" radius="0.08" height="0.7" 
                            material="color: #f5f5f5; roughness: 0.8" shadow="cast: true"></a-cylinder>
                <!-- Shoes -->
                <a-box position="0.12 0.05 0.05" width="0.1" height="0.08" depth="0.2" 
                       material="color: #ffffff; roughness: 0.6"></a-box>
                <a-box position="-0.12 0.05 0.05" width="0.1" height="0.08" depth="0.2" 
                       material="color: #ffffff; roughness: 0.6"></a-box>
            </a-entity>
            
            <!-- Torso (cricket shirt) -->
            <a-entity id="bowler-torso">
                <!-- Body -->
                <a-cylinder position="0 0.95 0" radius="0.2" height="0.6" 
                            material="color: #f8f8f8; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <!-- Shoulders -->
                <a-sphere position="0.22 1.1 0" radius="0.08" material="color: #f8f8f8; roughness: 0.7"></a-sphere>
                <a-sphere position="-0.22 1.1 0" radius="0.08" material="color: #f8f8f8; roughness: 0.7"></a-sphere>
                <!-- Collar (colored trim for team) -->
                <a-torus position="0 1.2 0" radius="0.12" radius-tubular="0.02" rotation="90 0 0"
                         material="color: #1a4d8f; roughness: 0.5"></a-torus>
            </a-entity>
            
            <!-- Arms -->
            <a-entity id="bowler-arms">
                <!-- Right arm (bowling arm) - will be animated -->
                <a-entity id="bowler-arm-right" position="0.28 1.1 0">
                    <!-- Upper arm -->
                    <a-cylinder position="0.12 0 0" radius="0.05" height="0.35" rotation="0 0 -80"
                                material="color: #DEB887; roughness: 0.8" shadow="cast: true"></a-cylinder>
                    <!-- Forearm -->
                    <a-cylinder position="0.35 -0.1 0" radius="0.045" height="0.3" rotation="0 0 -60"
                                material="color: #DEB887; roughness: 0.8" shadow="cast: true"></a-cylinder>
                    <!-- Hand -->
                    <a-sphere position="0.5 -0.15 0" radius="0.04" material="color: #DEB887; roughness: 0.8"></a-sphere>
                </a-entity>
                
                <!-- Left arm -->
                <a-entity id="bowler-arm-left" position="-0.28 1.1 0">
                    <a-cylinder position="-0.12 0 0" radius="0.05" height="0.35" rotation="0 0 80"
                                material="color: #DEB887; roughness: 0.8" shadow="cast: true"></a-cylinder>
                    <a-cylinder position="-0.35 -0.1 0" radius="0.045" height="0.3" rotation="0 0 60"
                                material="color: #DEB887; roughness: 0.8" shadow="cast: true"></a-cylinder>
                    <a-sphere position="-0.5 -0.15 0" radius="0.04" material="color: #DEB887; roughness: 0.8"></a-sphere>
                </a-entity>
            </a-entity>
            
            <!-- Head with cap -->
            <a-entity id="bowler-head" position="0 1.45 0">
                <!-- Head -->
                <a-sphere radius="0.12" material="color: #DEB887; roughness: 0.8" shadow="cast: true"></a-sphere>
                <!-- Cap -->
                <a-cylinder position="0 0.08 0" radius="0.13" height="0.08" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
                <!-- Cap brim -->
                <a-cylinder position="0 0.05 0.08" radius="0.14" height="0.02" rotation="20 0 0"
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             CRICKET BALL - Photorealistic with seam and shine
        ================================================================= -->
        <a-entity id="cricket-ball-container" position="0 1.8 -24" visible="false">
            <!-- Main ball (red leather) -->
            <a-sphere 
                id="cricket-ball"
                radius="0.036"
                material="color: #8B0000; 
                         roughness: 0.4; 
                         metalness: 0.1"
                shadow="cast: true; receive: false">
            </a-sphere>
            
            <!-- Ball seam (white stitching) - Primary seam -->
            <a-torus id="ball-seam-1" 
                     radius="0.036" 
                     radius-tubular="0.003"
                     segments-radial="6"
                     segments-tubular="32"
                     material="color: #ffffff; roughness: 0.3; emissive: #ffffff; emissiveIntensity: 0.2"
                     rotation="0 0 0">
            </a-torus>
            
            <!-- Secondary seam (perpendicular for realism) -->
            <a-torus id="ball-seam-2" 
                     radius="0.034" 
                     radius-tubular="0.002"
                     segments-radial="6"
                     segments-tubular="24"
                     material="color: #ffffff; roughness: 0.3"
                     rotation="90 0 0"
                     visible="true">
            </a-torus>
            
            <!-- Shine patch (one side shinier for swing) -->
            <a-sphere id="ball-shine"
                      radius="0.037"
                      theta-start="0"
                      theta-length="90"
                      phi-start="0"
                      phi-length="180"
                      material="color: #a00000; roughness: 0.2; metalness: 0.3; transparent: true; opacity: 0.4"
                      rotation="0 45 0">
            </a-sphere>
        </a-entity>
        
        <!-- Ball Trail - Dynamic trail effect -->
        <a-entity id="ball-trail"></a-entity>
        
        <!-- ================================================================
             FIELDERS - Better proportioned player models
        ================================================================= -->
        <a-entity id="fielders">
            <!-- Slip Fielder (crouched, ready position) -->
            <a-entity class="fielder" id="fielder-slip" position="3 0 2">
                <a-cylinder position="0 0.55 0" radius="0.15" height="0.8" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.1 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <!-- Cap -->
                <a-cylinder position="0 1.18 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
                <!-- Arms (ready position) -->
                <a-cylinder position="0.2 0.7 -0.15" radius="0.04" height="0.35" rotation="60 0 20"
                            material="color: #DEB887; roughness: 0.8"></a-cylinder>
                <a-cylinder position="-0.2 0.7 -0.15" radius="0.04" height="0.35" rotation="60 0 -20"
                            material="color: #DEB887; roughness: 0.8"></a-cylinder>
            </a-entity>
            
            <!-- Point Fielder -->
            <a-entity class="fielder" id="fielder-point" position="15 0 -5">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Cover Fielder -->
            <a-entity class="fielder" id="fielder-cover" position="18 0 -18">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Mid-off Fielder -->
            <a-entity class="fielder" id="fielder-midoff" position="12 0 -30">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Mid-on Fielder -->
            <a-entity class="fielder" id="fielder-midon" position="-12 0 -30">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Square Leg Fielder -->
            <a-entity class="fielder" id="fielder-squareleg" position="-15 0 -5">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Fine Leg Fielder -->
            <a-entity class="fielder" id="fielder-fineleg" position="-12 0 15">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Third Man Fielder -->
            <a-entity class="fielder" id="fielder-thirdman" position="12 0 15">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Long-off Boundary -->
            <a-entity class="fielder" id="fielder-longoff" position="30 0 -55">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- Long-on Boundary -->
            <a-entity class="fielder" id="fielder-longon" position="-30 0 -55">
                <a-cylinder position="0 0.6 0" radius="0.15" height="0.9" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-sphere position="0 1.2 0" radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                <a-cylinder position="0 1.28 0" radius="0.11" height="0.06" 
                            material="color: #1a4d8f; roughness: 0.6"></a-cylinder>
            </a-entity>
            
            <!-- ============================================================
                 WICKET KEEPER - Detailed with gloves, pads, helmet
            ============================================================= -->
            <a-entity class="fielder" id="wicket-keeper" position="0 0 2.5">
                <!-- Legs with pads -->
                <a-cylinder position="0.1 0.35 0" radius="0.08" height="0.65" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <a-cylinder position="-0.1 0.35 0" radius="0.08" height="0.65" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                <!-- Keeper pads (cream colored, larger) -->
                <a-box position="0.1 0.35 -0.06" width="0.12" height="0.5" depth="0.08" 
                       material="color: #f5f5dc; roughness: 0.6"></a-box>
                <a-box position="-0.1 0.35 -0.06" width="0.12" height="0.5" depth="0.08" 
                       material="color: #f5f5dc; roughness: 0.6"></a-box>
                
                <!-- Body (crouched) -->
                <a-cylinder position="0 0.75 0" radius="0.18" height="0.45" 
                            material="color: #f5f5f5; roughness: 0.7" shadow="cast: true"></a-cylinder>
                
                <!-- Head with helmet and face guard -->
                <a-entity id="keeper-head" position="0 1.05 0">
                    <a-sphere radius="0.1" material="color: #DEB887; roughness: 0.8"></a-sphere>
                    <!-- Helmet -->
                    <a-sphere position="0 0.03 0" radius="0.12" theta-length="120"
                              material="color: #1a4d8f; roughness: 0.4; metalness: 0.3"></a-sphere>
                    <!-- Face guard (grille) -->
                    <a-box position="0 -0.02 -0.11" width="0.12" height="0.1" depth="0.02"
                           material="color: #333333; metalness: 0.8; roughness: 0.3"></a-box>
                </a-entity>
                
                <!-- Wicket keeping gloves (large, padded) -->
                <a-entity id="keeper-gloves">
                    <!-- Right glove -->
                    <a-cylinder position="0.25 0.7 -0.2" radius="0.04" height="0.3" rotation="70 0 30"
                                material="color: #DEB887; roughness: 0.8"></a-cylinder>
                    <a-sphere position="0.32 0.55 -0.28" radius="0.08" 
                              material="color: #8B4513; roughness: 0.7"></a-sphere>
                    <!-- Glove webbing -->
                    <a-box position="0.32 0.55 -0.35" width="0.1" height="0.12" depth="0.02"
                           material="color: #654321; roughness: 0.8"></a-box>
                    
                    <!-- Left glove -->
                    <a-cylinder position="-0.25 0.7 -0.2" radius="0.04" height="0.3" rotation="70 0 -30"
                                material="color: #DEB887; roughness: 0.8"></a-cylinder>
                    <a-sphere position="-0.32 0.55 -0.28" radius="0.08" 
                              material="color: #8B4513; roughness: 0.7"></a-sphere>
                    <a-box position="-0.32 0.55 -0.35" width="0.1" height="0.12" depth="0.02"
                           material="color: #654321; roughness: 0.8"></a-box>
                </a-entity>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             VR CAMERA RIG & CONTROLLERS
             Player position with realistic cricket bat
        ================================================================= -->
        <a-entity id="rig" position="0 0 0">
            <a-camera id="camera" position="0 1.6 0" wasd-controls-enabled="false"></a-camera>
            
            <!-- Left Hand Controller (Menu/Navigation) -->
            <a-entity 
                id="left-hand"
                oculus-touch-controls="hand: left"
                laser-controls="hand: left">
            </a-entity>
            
            <!-- Right Hand Controller (Cricket Bat) -->
            <a-entity 
                id="right-hand"
                oculus-touch-controls="hand: right">
                
                <!-- ========================================================
                     CRICKET BAT - Photorealistic willow bat with details
                     Proper cricket bat proportions and materials
                ======================================================== -->
                <a-entity id="cricket-bat" rotation="-90 0 0" position="0 0 -0.1">
                    
                    <!-- Handle - Cane with rubber grip -->
                    <a-entity id="bat-handle">
                        <!-- Inner cane handle -->
                        <a-cylinder 
                            position="0 0.12 0" 
                            radius="0.016" 
                            height="0.28" 
                            material="color: #d4a574; roughness: 0.6">
                        </a-cylinder>
                        
                        <!-- Rubber grip (black with texture simulation) -->
                        <a-cylinder 
                            id="bat-grip"
                            position="0 0.05 0" 
                            radius="0.018" 
                            height="0.15" 
                            material="color: #1a1a1a; roughness: 0.9; metalness: 0">
                        </a-cylinder>
                        
                        <!-- Grip texture rings (simulating ridged rubber) -->
                        <a-torus position="0 0.02 0" radius="0.019" radius-tubular="0.002" rotation="90 0 0"
                                 material="color: #333; roughness: 0.8"></a-torus>
                        <a-torus position="0 0.04 0" radius="0.019" radius-tubular="0.002" rotation="90 0 0"
                                 material="color: #333; roughness: 0.8"></a-torus>
                        <a-torus position="0 0.06 0" radius="0.019" radius-tubular="0.002" rotation="90 0 0"
                                 material="color: #333; roughness: 0.8"></a-torus>
                        <a-torus position="0 0.08 0" radius="0.019" radius-tubular="0.002" rotation="90 0 0"
                                 material="color: #333; roughness: 0.8"></a-torus>
                        
                        <!-- Handle splice (where handle meets blade) -->
                        <a-cylinder 
                            position="0 0.22 0" 
                            radius="0.022" 
                            height="0.06" 
                            material="color: #c9a86c; roughness: 0.5">
                        </a-cylinder>
                    </a-entity>
                    
                    <!-- Blade - English willow style -->
                    <a-entity id="bat-blade-assembly" position="0 0.52 0">
                        <!-- Main blade face (front - hitting surface) -->
                        <a-box 
                            id="bat-blade"
                            position="0 0 0.012" 
                            width="0.108" 
                            height="0.44" 
                            depth="0.025" 
                            material="color: #f5e6c8; roughness: 0.7; metalness: 0"
                            shadow="cast: true">
                        </a-box>
                        
                        <!-- Blade back (spine - curved/ridged) -->
                        <a-box 
                            position="0 0 -0.018" 
                            width="0.095" 
                            height="0.44" 
                            depth="0.02" 
                            material="color: #e8d4b0; roughness: 0.65">
                        </a-box>
                        
                        <!-- Spine ridge (center ridge on back) -->
                        <a-box 
                            position="0 0 -0.032" 
                            width="0.03" 
                            height="0.38" 
                            depth="0.015" 
                            material="color: #e0c8a0; roughness: 0.6">
                        </a-box>
                        
                        <!-- Bat edges (thicker sides) -->
                        <a-box 
                            position="-0.055 0 0" 
                            width="0.012" 
                            height="0.44" 
                            depth="0.045" 
                            material="color: #e8d4b0; roughness: 0.65">
                        </a-box>
                        <a-box 
                            position="0.055 0 0" 
                            width="0.012" 
                            height="0.44" 
                            depth="0.045" 
                            material="color: #e8d4b0; roughness: 0.65">
                        </a-box>
                        
                        <!-- Sweet spot area (slightly darker from ball marks) -->
                        <a-box 
                            id="sweet-spot"
                            position="0 -0.05 0.026" 
                            width="0.07" 
                            height="0.12" 
                            depth="0.002" 
                            material="color: #d4c4a8; roughness: 0.8; transparent: true; opacity: 0.6">
                        </a-box>
                        
                        <!-- Sponsor sticker area (simplified logo) -->
                        <a-plane 
                            position="0 0.1 0.026" 
                            width="0.08" 
                            height="0.06" 
                            material="color: #1a4d8f; roughness: 0.3">
                        </a-plane>
                        <a-text 
                            position="0 0.1 0.028" 
                            value="PRO" 
                            align="center" 
                            color="#ffffff" 
                            width="0.15">
                        </a-text>
                        
                        <!-- Edge scuff marks (signs of use) -->
                        <a-box position="-0.052 0.05 0.01" width="0.008" height="0.03" depth="0.01" 
                               material="color: #c0b090; roughness: 0.9"></a-box>
                        <a-box position="0.052 -0.08 0.01" width="0.008" height="0.025" depth="0.01" 
                               material="color: #c0b090; roughness: 0.9"></a-box>
                    </a-entity>
                    
                    <!-- Toe - bottom of bat with toe guard -->
                    <a-entity id="bat-toe" position="0 0.76 0">
                        <!-- Rounded toe shape -->
                        <a-box 
                            position="0 0 0" 
                            width="0.108" 
                            height="0.03" 
                            depth="0.04" 
                            material="color: #e8d4b0; roughness: 0.65">
                        </a-box>
                        
                        <!-- Toe guard (rubber protection - darker) -->
                        <a-box 
                            position="0 0.005 0.015" 
                            width="0.11" 
                            height="0.025" 
                            depth="0.02" 
                            material="color: #2a2a2a; roughness: 0.85">
                        </a-box>
                    </a-entity>
                    
                    <!-- Visual sweet spot guide (shown during practice) -->
                    <a-box 
                        id="sweet-spot-guide"
                        position="0 0.47 0.04" 
                        width="0.06" 
                        height="0.1" 
                        depth="0.001" 
                        material="color: #00ff00; emissive: #00ff00; emissiveIntensity: 0.3; transparent: true; opacity: 0.2"
                        visible="false">
                    </a-box>
                </a-entity>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             IN-VR HUD - Floating scoreboard and info display
        ================================================================= -->
        <a-entity id="vr-hud" position="0 2.8 -4" look-at="[camera]">
            <!-- Scoreboard background panel -->
            <a-entity id="vr-scoreboard-container">
                <a-plane 
                    id="vr-scoreboard"
                    position="0 0 0" 
                    width="2.4" 
                    height="1" 
                    material="color: #0a0a0a; opacity: 0.85; transparent: true"
                    visible="false">
                </a-plane>
                
                <!-- Team color accent bar -->
                <a-plane
                    position="0 0.45 0.01"
                    width="2.4"
                    height="0.08"
                    material="color: #1a4d8f; shader: flat"
                    visible="false"
                    class="vr-hud-element">
                </a-plane>
                
                <!-- Score display -->
                <a-text 
                    id="vr-score-text"
                    value="0/0"
                    align="center"
                    position="0 0.2 0.02"
                    scale="1.8 1.8 1.8"
                    color="#ffffff"
                    font="monoid"
                    visible="false">
                </a-text>
                
                <!-- Balls/Overs info -->
                <a-text 
                    id="vr-balls-text"
                    value="Balls: 0"
                    align="center"
                    position="0 -0.05 0.02"
                    scale="0.6 0.6 0.6"
                    color="#cccccc"
                    visible="false">
                </a-text>
                
                <!-- Strike rate -->
                <a-text 
                    id="vr-sr-text"
                    value="SR: 0.00"
                    align="center"
                    position="0 -0.2 0.02"
                    scale="0.5 0.5 0.5"
                    color="#aaaaaa"
                    visible="false">
                </a-text>
                
                <!-- Last shot type -->
                <a-text 
                    id="vr-shot-text"
                    value=""
                    align="center"
                    position="0 -0.35 0.02"
                    scale="0.5 0.5 0.5"
                    color="#ffd700"
                    visible="false">
                </a-text>
            </a-entity>
        </a-entity>
        
        <!-- ================================================================
             PARTICLE EFFECTS CONTAINERS
        ================================================================= -->
        
        <!-- Hit effect particles (bat contact) -->
        <a-entity id="hit-particles" position="0 1 0" visible="false">
            <a-sphere class="hit-particle" radius="0.03" material="color: #FFD700; emissive: #FFD700; emissiveIntensity: 0.8; shader: flat; opacity: 0.9; transparent: true"></a-sphere>
            <a-sphere class="hit-particle" radius="0.02" material="color: #FFA500; emissive: #FFA500; emissiveIntensity: 0.6; shader: flat; opacity: 0.8; transparent: true" position="0.05 0.02 0"></a-sphere>
            <a-sphere class="hit-particle" radius="0.02" material="color: #FF6600; emissive: #FF6600; emissiveIntensity: 0.6; shader: flat; opacity: 0.8; transparent: true" position="-0.05 0.02 0"></a-sphere>
            <a-sphere class="hit-particle" radius="0.015" material="color: #FFFF00; emissive: #FFFF00; emissiveIntensity: 0.7; shader: flat; opacity: 0.7; transparent: true" position="0 0.05 0.03"></a-sphere>
        </a-entity>
        
        <!-- Dust particles (ball bounce on pitch) -->
        <a-entity id="dust-particles" position="0 0.05 -10" visible="false">
            <a-sphere class="dust-particle" radius="0.05" material="color: #c4a35a; opacity: 0.4; transparent: true; shader: flat"></a-sphere>
            <a-sphere class="dust-particle" radius="0.04" material="color: #b8956e; opacity: 0.3; transparent: true; shader: flat" position="0.08 0.02 0"></a-sphere>
            <a-sphere class="dust-particle" radius="0.035" material="color: #d4b896; opacity: 0.35; transparent: true; shader: flat" position="-0.07 0.03 0.02"></a-sphere>
            <a-sphere class="dust-particle" radius="0.03" material="color: #c9a97c; opacity: 0.25; transparent: true; shader: flat" position="0.03 0.04 -0.05"></a-sphere>
        </a-entity>
        
        <!-- Stump LED glow effect container -->
        <a-entity id="stump-glow-effect" position="0 0.4 0.5" visible="false">
            <a-sphere radius="0.3" material="color: #ff0000; emissive: #ff0000; emissiveIntensity: 1; transparent: true; opacity: 0.3; shader: flat"></a-sphere>
        </a-entity>
        
    </a-scene>

    <script>
    // ============================================================================
    // VR CRICKET GAME - Main Game Logic
    // ============================================================================
    
    (function() {
        'use strict';
        
        // ========================================================================
        // GAME CONFIGURATION
        // ========================================================================
        
        const CONFIG = {
            // =================================================================
            // PITCH DIMENSIONS (in meters, real cricket proportions)
            // =================================================================
            pitchLength: 22,        // Standard cricket pitch = 22 yards = 20.12m
            boundaryDistance: 70,   // Typical boundary distance
            
            // Batsman position (where player stands)
            batsmanZ: 0,           // Batsman at z = 0
            bowlerZ: -24,          // Bowler releases at z = -24
            
            // =================================================================
            // BALL PHYSICS - Realistic Cricket Ball Properties
            // =================================================================
            ballRadius: 0.036,      // Cricket ball radius (~7.2cm diameter)
            ballMass: 0.163,        // Cricket ball mass in kg (156-163g)
            
            // Gravity (m/s¬≤)
            gravity: -9.81,
            
            // Air resistance coefficient (drag)
            // Higher = more drag, ball slows down more
            airResistance: 0.995,   // Very slight air drag per frame
            
            // Ground/pitch properties
            groundFriction: 0.75,   // Friction when ball rolls on ground
            pitchBounceCoefficient: 0.5,  // Coefficient of restitution for pitch (0.4-0.6 realistic)
            
            // =================================================================
            // BALL SPEEDS (meters per second)
            // Converted from km/h: divide by 3.6
            // Easy: 60-80 km/h = 16.7-22.2 m/s
            // Medium: 100-130 km/h = 27.8-36.1 m/s
            // Hard: 140-160 km/h = 38.9-44.4 m/s
            // =================================================================
            speeds: {
                easy:   { min: 16, max: 22 },    // 60-80 km/h - Very playable
                medium: { min: 25, max: 32 },    // 90-115 km/h - Challenging
                hard:   { min: 35, max: 42 }     // 125-150 km/h - Professional pace
            },
            
            // =================================================================
            // BAT PROPERTIES
            // =================================================================
            batLength: 0.85,        // Standard bat length
            batWidth: 0.11,         // Bat blade width
            sweetSpotSize: 0.12,    // Sweet spot radius
            edgeWidth: 0.015,       // Edge thickness
            
            // Collision detection radius (generous for playability)
            batCollisionRadius: 0.35,
            
            // =================================================================
            // TIMING WINDOWS (seconds)
            // =================================================================
            timing: {
                perfect: 0.04,      // ¬±40ms for perfect timing
                good: 0.08,         // ¬±80ms for good timing
                fair: 0.12          // ¬±120ms for fair timing
            },
            
            // =================================================================
            // SCORING
            // =================================================================
            boundaryFour: 4,
            boundarySix: 6,
            
            // =================================================================
            // GAME SETTINGS
            // =================================================================
            ballsPerOver: 6,
            wicketsPerInnings: 1,
            
            // Debug mode (set to true to see trajectory predictions)
            debugMode: false
        };
        
        // ========================================================================
        // GAME STATE
        // ========================================================================
        
        const GameState = {
            // Game settings
            mode: 'practice', // practice, challenge, survival, target
            difficulty: 'medium',
            totalOvers: 1,
            targetScore: 0,
            
            // Current game state
            isPlaying: false,
            isPaused: false,
            isGameOver: false,
            isBallInPlay: false,
            isReadyForBall: false,
            
            // Score tracking
            runs: 0,
            wickets: 0,
            ballsFaced: 0,
            fours: 0,
            sixes: 0,
            dotBalls: 0,
            bestShot: '',
            highScore: localStorage.getItem('cricketHighScore') || 0,
            
            // Ball state
            ballPosition: { x: 0, y: 1.5, z: -24 },
            ballVelocity: { x: 0, y: 0, z: 0 },
            ballSpin: { x: 0, y: 0, z: 0 },
            ballHasBouncedOnPitch: false,
            ballHitByBat: false,
            
            // Bat tracking
            batPosition: { x: 0, y: 1, z: 0 },
            batPrevPosition: { x: 0, y: 1, z: 0 },
            batVelocity: { x: 0, y: 0, z: 0 },
            batRotation: { x: 0, y: 0, z: 0 },
            
            // Delivery info
            currentDeliveryType: 'good-length',
            currentLine: 'middle',
            
            // Reset game state
            reset: function() {
                this.runs = 0;
                this.wickets = 0;
                this.ballsFaced = 0;
                this.fours = 0;
                this.sixes = 0;
                this.dotBalls = 0;
                this.bestShot = '';
                this.isPlaying = true;
                this.isPaused = false;
                this.isGameOver = false;
                this.isBallInPlay = false;
                this.isReadyForBall = true;
                this.ballHasBouncedOnPitch = false;
                this.ballHitByBat = false;
            },
            
            // Calculate strike rate
            getStrikeRate: function() {
                if (this.ballsFaced === 0) return 0;
                return ((this.runs / this.ballsFaced) * 100).toFixed(2);
            },
            
            // Get remaining balls
            getRemainingBalls: function() {
                if (this.mode === 'practice') return '‚àû';
                return (this.totalOvers * CONFIG.ballsPerOver) - this.ballsFaced;
            },
            
            // Check if innings should end
            checkInningsEnd: function() {
                if (this.mode === 'practice') return false;
                
                if (this.mode === 'survival' && this.wickets >= 1) return true;
                if (this.mode === 'challenge' && this.ballsFaced >= this.totalOvers * CONFIG.ballsPerOver) return true;
                if (this.mode === 'target') {
                    if (this.runs >= this.targetScore) return true;
                    if (this.ballsFaced >= this.totalOvers * CONFIG.ballsPerOver) return true;
                    if (this.wickets >= 1) return true;
                }
                
                return false;
            }
        };
        
        // ========================================================================
        // AUDIO SYSTEM
        // ========================================================================
        
        const AudioSystem = {
            context: null,
            
            init: function() {
                try {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('Web Audio API not supported');
                }
            },
            
            // Generate a bat hit sound
            playBatHit: function(quality) {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                // Different sounds based on quality
                if (quality === 'perfect') {
                    oscillator.frequency.setValueAtTime(800, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, this.context.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.5, this.context.currentTime);
                } else if (quality === 'edge') {
                    oscillator.frequency.setValueAtTime(1200, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, this.context.currentTime + 0.05);
                    gainNode.gain.setValueAtTime(0.3, this.context.currentTime);
                } else {
                    oscillator.frequency.setValueAtTime(600, this.context.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, this.context.currentTime + 0.08);
                    gainNode.gain.setValueAtTime(0.4, this.context.currentTime);
                }
                
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.15);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.15);
            },
            
            // Ball hitting stumps
            playStumpsHit: function() {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(150, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, this.context.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.6, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.3);
            },
            
            // Crowd cheer
            playCrowdCheer: function(intensity) {
                if (!this.context) return;
                
                // Create noise for crowd
                const bufferSize = this.context.sampleRate * 0.5;
                const buffer = this.context.createBuffer(1, bufferSize, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.3;
                }
                
                const noise = this.context.createBufferSource();
                noise.buffer = buffer;
                
                const filter = this.context.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(intensity === 'six' ? 2000 : 1000, this.context.currentTime);
                
                const gainNode = this.context.createGain();
                gainNode.gain.setValueAtTime(intensity === 'six' ? 0.4 : 0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 1);
                
                noise.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                noise.start(this.context.currentTime);
                noise.stop(this.context.currentTime + 1);
            },
            
            // Ball bounce
            playBounce: function() {
                if (!this.context) return;
                
                const oscillator = this.context.createOscillator();
                const gainNode = this.context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.context.destination);
                
                oscillator.frequency.setValueAtTime(300, this.context.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, this.context.currentTime + 0.05);
                gainNode.gain.setValueAtTime(0.2, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.05);
                
                oscillator.start(this.context.currentTime);
                oscillator.stop(this.context.currentTime + 0.05);
            }
        };
        
        // ========================================================================
        // BOWLING SYSTEM - PROPER PROJECTILE MOTION PHYSICS
        // ========================================================================
        // 
        // PHYSICS FORMULAS USED:
        // ----------------------
        // 1. Projectile Motion:
        //    - Horizontal: x(t) = x0 + vx*t
        //    - Vertical:   y(t) = y0 + vy*t + 0.5*g*t¬≤
        // 
        // 2. To hit a target at (targetX, targetY, targetZ) from (startX, startY, startZ):
        //    - Time of flight: t = (targetZ - startZ) / vz
        //    - Required vy: vy = (targetY - startY - 0.5*g*t¬≤) / t
        //    - Required vx: vx = (targetX - startX) / t
        // 
        // 3. For bouncing deliveries:
        //    - First phase: ball travels to bounce point
        //    - At bounce: vy reverses with coefficient of restitution
        //    - Second phase: ball travels from bounce to batsman
        //
        // ========================================================================
        
        const BowlingSystem = {
            
            // Current ball speed for display
            currentBallSpeed: 0,
            
            /**
             * Generate a random delivery based on difficulty
             */
            generateDelivery: function() {
                const difficulty = GameState.difficulty;
                const speedRange = CONFIG.speeds[difficulty];
                
                // Random speed within range (m/s)
                const speed = speedRange.min + Math.random() * (speedRange.max - speedRange.min);
                this.currentBallSpeed = speed;
                
                // Select delivery type based on difficulty
                const deliveryTypes = this.getDeliveryTypes(difficulty);
                const deliveryType = deliveryTypes[Math.floor(Math.random() * deliveryTypes.length)];
                
                // Line variation (off, middle, leg stump)
                const lines = ['off', 'middle', 'leg'];
                const lineWeights = difficulty === 'hard' ? [0.35, 0.35, 0.3] : [0.3, 0.4, 0.3];
                const line = this.weightedRandom(lines, lineWeights);
                
                GameState.currentDeliveryType = deliveryType;
                GameState.currentLine = line;
                
                // Calculate delivery parameters with proper physics
                const deliveryParams = this.calculateDeliveryPhysics(deliveryType, line, speed);
                
                // Log for debugging
                console.log(`üìç Delivery: ${deliveryType}, Line: ${line}, Speed: ${(speed * 3.6).toFixed(1)} km/h`);
                console.log(`üìç Start: (${deliveryParams.startPos.x.toFixed(2)}, ${deliveryParams.startPos.y.toFixed(2)}, ${deliveryParams.startPos.z.toFixed(2)})`);
                console.log(`üìç Velocity: (${deliveryParams.velocity.x.toFixed(2)}, ${deliveryParams.velocity.y.toFixed(2)}, ${deliveryParams.velocity.z.toFixed(2)})`);
                
                return {
                    speed: speed,
                    speedKmh: speed * 3.6,
                    type: deliveryType,
                    line: line,
                    ...deliveryParams
                };
            },
            
            /**
             * Get available delivery types based on difficulty
             */
            getDeliveryTypes: function(difficulty) {
                if (difficulty === 'easy') {
                    // Easy: mostly hittable deliveries
                    return ['good-length', 'half-volley', 'full-toss', 'good-length', 'half-volley'];
                } else if (difficulty === 'medium') {
                    // Medium: mix of deliveries
                    return ['good-length', 'half-volley', 'yorker', 'bouncer', 'full-toss'];
                } else {
                    // Hard: challenging deliveries
                    return ['good-length', 'yorker', 'bouncer', 'yorker', 'good-length', 'bouncer'];
                }
            },
            
            /**
             * Weighted random selection
             */
            weightedRandom: function(items, weights) {
                const totalWeight = weights.reduce((a, b) => a + b, 0);
                let random = Math.random() * totalWeight;
                
                for (let i = 0; i < items.length; i++) {
                    random -= weights[i];
                    if (random <= 0) return items[i];
                }
                return items[items.length - 1];
            },
            
            /**
             * CORE PHYSICS CALCULATION
             * Calculate proper projectile motion for cricket deliveries
             * 
             * @param {string} type - Delivery type (good-length, yorker, bouncer, etc.)
             * @param {string} line - Line of the delivery (off, middle, leg)
             * @param {number} speed - Ball speed in m/s
             * @returns {object} - Starting position and velocity vectors
             */
            calculateDeliveryPhysics: function(type, line, speed) {
                // =========================================================
                // STARTING POSITION (Bowler's release point)
                // =========================================================
                const startPos = {
                    x: 0,           // Center of pitch
                    y: 2.1,         // Release height (bowler's arm)
                    z: -24          // Bowler's end
                };
                
                // =========================================================
                // TARGET POSITION (Where ball should arrive at batsman)
                // =========================================================
                // Batsman stands at z = 0 to z = 1
                // We want ball to arrive at hitting zone
                
                let targetZ = 0.5;    // Default: reach batsman's crease
                let targetY = 1.0;    // Default: stump height
                let bounceZ = null;   // Z-position where ball bounces (null = no bounce)
                
                // =========================================================
                // DELIVERY TYPE PARAMETERS
                // Each delivery type has different target and bounce points
                // =========================================================
                
                switch (type) {
                    case 'full-toss':
                        // No bounce - arrives at waist to chest height
                        targetZ = 0.5;
                        targetY = 1.0 + Math.random() * 0.3;  // 1.0-1.3m height
                        bounceZ = null;  // No bounce
                        break;
                        
                    case 'half-volley':
                        // Bounces very close to batsman - easy to drive
                        targetZ = 0.5;
                        targetY = 0.6 + Math.random() * 0.3;  // Knee to thigh height
                        bounceZ = -2;    // Bounces 2m in front of batsman
                        break;
                        
                    case 'good-length':
                        // Classic delivery - bounces 6-8m before stumps
                        targetZ = 0.5;
                        targetY = 0.9 + Math.random() * 0.4;  // Stump to chest height
                        bounceZ = -7 + Math.random() * 2;     // Bounces 5-7m before batsman
                        break;
                        
                    case 'yorker':
                        // Pitches at batsman's feet - very low
                        targetZ = 0.3;
                        targetY = 0.15;   // Just above ground level
                        bounceZ = -0.3;   // Bounces right at the crease
                        break;
                        
                    case 'bouncer':
                        // Short pitch - bounces early, rises to head height
                        targetZ = 0.5;
                        targetY = 1.6 + Math.random() * 0.3;  // Chest to head height
                        bounceZ = -12 + Math.random() * 2;    // Bounces 10-12m before batsman
                        break;
                        
                    default:
                        // Default to good length
                        targetZ = 0.5;
                        targetY = 1.0;
                        bounceZ = -6;
                }
                
                // =========================================================
                // LINE ADJUSTMENT (Lateral offset)
                // =========================================================
                let targetX = 0;
                if (line === 'off') {
                    targetX = 0.2 + Math.random() * 0.15;   // Outside off stump
                } else if (line === 'leg') {
                    targetX = -0.2 - Math.random() * 0.15;  // Down leg side
                } else {
                    targetX = (Math.random() - 0.5) * 0.2;  // Around middle stump
                }
                
                // =========================================================
                // PHYSICS CALCULATION
                // =========================================================
                
                let velocity;
                
                if (bounceZ === null) {
                    // =====================================================
                    // FULL TOSS (No bounce) - Direct trajectory
                    // =====================================================
                    velocity = this.calculateDirectTrajectory(startPos, targetX, targetY, targetZ, speed);
                } else {
                    // =====================================================
                    // BOUNCING DELIVERY - Two-phase trajectory
                    // =====================================================
                    velocity = this.calculateBouncingTrajectory(startPos, targetX, targetY, targetZ, bounceZ, speed);
                }
                
                // Add slight random variation for realism
                velocity.x += (Math.random() - 0.5) * 0.5;
                velocity.y += (Math.random() - 0.5) * 0.3;
                
                return {
                    startPos: startPos,
                    velocity: velocity,
                    bounceZ: bounceZ,
                    targetY: targetY,
                    targetX: targetX,
                    targetZ: targetZ
                };
            },
            
            /**
             * Calculate velocity for direct (non-bouncing) delivery
             * Uses projectile motion equations
             */
            calculateDirectTrajectory: function(startPos, targetX, targetY, targetZ, speed) {
                // Distance to travel
                const dz = targetZ - startPos.z;  // Will be positive (moving towards batsman)
                const dx = targetX - startPos.x;
                const dy = targetY - startPos.y;
                
                // The ball needs to travel distance dz at the given speed
                // Most of the speed is in the z-direction
                // Calculate time based on forward velocity
                
                // vz is the main component - ball speed is roughly the forward speed
                // We use 90% of speed for forward motion, rest for adjustments
                const vz = speed * 0.95;
                
                // Time to reach target
                const t = Math.abs(dz) / vz;
                
                // Required lateral velocity
                const vx = dx / t;
                
                // Required vertical velocity (accounting for gravity)
                // y(t) = y0 + vy*t + 0.5*g*t¬≤
                // targetY = startY + vy*t + 0.5*g*t¬≤
                // vy = (targetY - startY - 0.5*g*t¬≤) / t
                const g = CONFIG.gravity;  // Negative value
                const vy = (dy - 0.5 * g * t * t) / t;
                
                console.log(`‚ö° Direct trajectory: t=${t.toFixed(3)}s, vz=${vz.toFixed(2)}, vy=${vy.toFixed(2)}`);
                
                return { x: vx, y: vy, z: vz };
            },
            
            /**
             * Calculate velocity for bouncing delivery
             * Ball travels in two phases: before bounce and after bounce
             */
            calculateBouncingTrajectory: function(startPos, targetX, targetY, targetZ, bounceZ, speed) {
                // =========================================================
                // PHASE 1: From bowler to bounce point
                // =========================================================
                
                const bounceY = CONFIG.ballRadius;  // Ball bounces at ground level
                
                // Distance to bounce point
                const dz1 = bounceZ - startPos.z;
                
                // Forward velocity (main component of speed)
                const vz = speed * 0.95;
                
                // Time to reach bounce point
                const t1 = Math.abs(dz1) / vz;
                
                // We need to find vy such that ball hits the ground at bounceZ
                // Using: y(t1) = bounceY
                // startY + vy*t1 + 0.5*g*t1¬≤ = bounceY
                // vy = (bounceY - startY - 0.5*g*t1¬≤) / t1
                const g = CONFIG.gravity;
                const vy_initial = (bounceY - startPos.y - 0.5 * g * t1 * t1) / t1;
                
                // =========================================================
                // PHASE 2: After bounce (for reference - physics system handles this)
                // =========================================================
                // After bounce, vy reverses with coefficient of restitution
                // Ball continues to target
                
                // Calculate vx based on total flight to target
                const totalDz = targetZ - startPos.z;
                const totalTime = Math.abs(totalDz) / vz;
                const vx = (targetX - startPos.x) / totalTime;
                
                console.log(`‚ö° Bouncing trajectory: bounceZ=${bounceZ.toFixed(1)}, t1=${t1.toFixed(3)}s, vy=${vy_initial.toFixed(2)}`);
                
                return { x: vx, y: vy_initial, z: vz };
            },
            
            /**
             * Get current ball speed in km/h for display
             */
            getBallSpeedKmh: function() {
                return (this.currentBallSpeed * 3.6).toFixed(0);
            }
        };
        
        // ========================================================================
        // PHYSICS SYSTEM - Enhanced Ball Physics
        // ========================================================================
        
        const PhysicsSystem = {
            
            // Track bounce count
            bounceCount: 0,
            
            /**
             * Update ball position using physics simulation
             * Called every frame when ball is in play
             */
            updateBall: function(deltaTime) {
                if (!GameState.isBallInPlay) return;
                
                // Clamp deltaTime to prevent physics explosion
                deltaTime = Math.min(deltaTime, 0.05);
                
                const ball = GameState.ballPosition;
                const vel = GameState.ballVelocity;
                
                // =========================================================
                // GRAVITY
                // =========================================================
                vel.y += CONFIG.gravity * deltaTime;
                
                // =========================================================
                // AIR RESISTANCE (very subtle)
                // =========================================================
                vel.x *= CONFIG.airResistance;
                vel.z *= CONFIG.airResistance;
                
                // =========================================================
                // UPDATE POSITION
                // =========================================================
                ball.x += vel.x * deltaTime;
                ball.y += vel.y * deltaTime;
                ball.z += vel.z * deltaTime;
                
                // =========================================================
                // GROUND/PITCH COLLISION
                // =========================================================
                if (ball.y <= CONFIG.ballRadius) {
                    ball.y = CONFIG.ballRadius;
                    
                    // Bounce with coefficient of restitution
                    vel.y = -vel.y * CONFIG.pitchBounceCoefficient;
                    
                    // Apply friction to horizontal components
                    vel.x *= CONFIG.groundFriction;
                    vel.z *= CONFIG.groundFriction;
                    
                    this.bounceCount++;
                    
                    // Play bounce sound on first pitch bounce and show dust effect
                    if (!GameState.ballHasBouncedOnPitch && ball.z > -20 && ball.z < 5) {
                        GameState.ballHasBouncedOnPitch = true;
                        AudioSystem.playBounce();
                        
                        // Show dust particles at bounce location
                        this.showDustParticles(ball.x, 0.02, ball.z);
                        
                        console.log(`üèè Ball bounced at z=${ball.z.toFixed(2)}, new vy=${vel.y.toFixed(2)}`);
                    }
                    
                    // Ball has essentially stopped
                    if (Math.abs(vel.y) < 0.5 && Math.abs(vel.x) < 0.3 && Math.abs(vel.z) < 0.3) {
                        this.ballStopped();
                        return;
                    }
                }
                
                // =========================================================
                // BALL PASSED BATSMAN CHECK
                // =========================================================
                if (ball.z > 5 && !GameState.ballHitByBat) {
                    // Ball passed the batsman without being hit
                    console.log(`üèè Ball passed batsman at z=${ball.z.toFixed(2)}`);
                    this.ballStopped();
                    return;
                }
                
                // =========================================================
                // CHECK GAME EVENTS
                // =========================================================
                this.checkBoundary();
                this.checkStumps();
                this.checkFielderCatch();
                
                // =========================================================
                // UPDATE VISUAL
                // =========================================================
                const ballEntity = document.getElementById('cricket-ball');
                if (ballEntity) {
                    ballEntity.setAttribute('position', `${ball.x.toFixed(3)} ${ball.y.toFixed(3)} ${ball.z.toFixed(3)}`);
                }
                
                // Update ball trail
                this.updateBallTrail();
                
                // Debug logging (every 30 frames approx)
                if (CONFIG.debugMode && Math.random() < 0.03) {
                    console.log(`üîµ Ball: pos=(${ball.x.toFixed(2)}, ${ball.y.toFixed(2)}, ${ball.z.toFixed(2)}) vel=(${vel.x.toFixed(2)}, ${vel.y.toFixed(2)}, ${vel.z.toFixed(2)})`);
                }
            },
            
            // Check if ball crossed boundary
            checkBoundary: function() {
                if (!GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const distanceFromCenter = Math.sqrt(ball.x * ball.x + Math.pow(ball.z + 11, 2));
                
                if (distanceFromCenter >= CONFIG.boundaryDistance) {
                    // Check if it was a six (ball was in air) or four (bounced)
                    if (ball.y > 0.5) {
                        // Six!
                        GameState.runs += 6;
                        GameState.sixes++;
                        GameState.bestShot = 'SIX!';
                        showShotFeedback('SIX!', 'six');
                        AudioSystem.playCrowdCheer('six');
                    } else {
                        // Four!
                        GameState.runs += 4;
                        GameState.fours++;
                        GameState.bestShot = 'FOUR!';
                        showShotFeedback('FOUR!', 'four');
                        AudioSystem.playCrowdCheer('four');
                    }
                    
                    this.endDelivery();
                }
            },
            
            // Check if ball hit stumps
            checkStumps: function() {
                if (GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const stumpsPos = { x: 0, y: 0.35, z: 0.5 };
                
                // Check if ball is near stumps
                if (ball.z > 0.3 && ball.z < 0.7 &&
                    Math.abs(ball.x) < 0.15 &&
                    ball.y < 0.75 && ball.y > 0) {
                    
                    // BOWLED!
                    GameState.wickets++;
                    showShotFeedback('BOWLED!', 'out');
                    AudioSystem.playStumpsHit();
                    
                    // Animate bails and show LED glow effect
                    this.animateBails();
                    this.showStumpGlow();
                    
                    this.endDelivery();
                }
            },
            
            // Check for catches
            checkFielderCatch: function() {
                if (!GameState.ballHitByBat) return;
                if (GameState.ballPosition.y <= 0.3) return; // Ball too low
                
                const ball = GameState.ballPosition;
                const fielders = document.querySelectorAll('.fielder');
                
                fielders.forEach(fielder => {
                    const pos = fielder.getAttribute('position');
                    const distance = Math.sqrt(
                        Math.pow(ball.x - pos.x, 2) +
                        Math.pow(ball.z - pos.z, 2)
                    );
                    
                    // Catch radius depends on difficulty
                    const catchRadius = GameState.difficulty === 'easy' ? 1 : 
                                       GameState.difficulty === 'medium' ? 1.5 : 2;
                    
                    if (distance < catchRadius && ball.y > 0.3 && ball.y < 3) {
                        // Random catch success based on difficulty
                        const catchChance = GameState.difficulty === 'easy' ? 0.3 :
                                           GameState.difficulty === 'medium' ? 0.5 : 0.7;
                        
                        if (Math.random() < catchChance) {
                            // CAUGHT!
                            GameState.wickets++;
                            showShotFeedback('CAUGHT!', 'out');
                            this.endDelivery();
                        }
                    }
                });
            },
            
            // Ball stopped rolling
            ballStopped: function() {
                if (!GameState.ballHitByBat) {
                    // Missed the ball - check if it was a wide or passed stumps
                    const ball = GameState.ballPosition;
                    if (ball.z > 2) {
                        // Ball passed - could be wide or keeper stopped it
                        this.endDelivery();
                    }
                } else {
                    // Calculate runs based on where ball stopped
                    const ball = GameState.ballPosition;
                    const distanceFromCenter = Math.sqrt(ball.x * ball.x + Math.pow(ball.z + 11, 2));
                    
                    let runs = 0;
                    if (distanceFromCenter > 50) runs = 3;
                    else if (distanceFromCenter > 30) runs = 2;
                    else if (distanceFromCenter > 15) runs = 1;
                    
                    if (runs > 0) {
                        GameState.runs += runs;
                        showShotFeedback(`${runs} RUN${runs > 1 ? 'S' : ''}`, 'runs');
                    } else {
                        GameState.dotBalls++;
                        showShotFeedback('DOT BALL', 'runs');
                    }
                    
                    this.endDelivery();
                }
            },
            
            // Animate bails falling
            animateBails: function() {
                const bail1 = document.getElementById('bail-1');
                const bail2 = document.getElementById('bail-2');
                
                if (bail1) {
                    bail1.setAttribute('animation', {
                        property: 'position',
                        to: '-0.1 0.5 0.2',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                    bail1.setAttribute('animation__rot', {
                        property: 'rotation',
                        to: '45 30 60',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                }
                
                if (bail2) {
                    bail2.setAttribute('animation', {
                        property: 'position',
                        to: '0.1 0.5 0.2',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                    bail2.setAttribute('animation__rot', {
                        property: 'rotation',
                        to: '-45 -30 -60',
                        dur: 500,
                        easing: 'easeOutQuad'
                    });
                }
            },
            
            // Reset bails position
            resetBails: function() {
                const bail1 = document.getElementById('bail-1');
                const bail2 = document.getElementById('bail-2');
                
                if (bail1) {
                    bail1.removeAttribute('animation');
                    bail1.removeAttribute('animation__rot');
                    bail1.setAttribute('position', '-0.0575 0.72 0');
                    bail1.setAttribute('rotation', '0 0 0');
                }
                
                if (bail2) {
                    bail2.removeAttribute('animation');
                    bail2.removeAttribute('animation__rot');
                    bail2.setAttribute('position', '0.0575 0.72 0');
                    bail2.setAttribute('rotation', '0 0 0');
                }
            },
            
            // Update ball trail
            updateBallTrail: function() {
                // Simple trail using position markers
                const trailContainer = document.getElementById('ball-trail');
                if (!trailContainer) return;
                
                // Create trail marker - make it larger and brighter
                const marker = document.createElement('a-sphere');
                marker.setAttribute('position', `${GameState.ballPosition.x} ${GameState.ballPosition.y} ${GameState.ballPosition.z}`);
                marker.setAttribute('radius', '0.08');
                marker.setAttribute('color', '#FFD700');
                marker.setAttribute('opacity', '0.7');
                marker.setAttribute('material', 'shader: flat; emissive: #FFD700; emissiveIntensity: 0.8');
                
                trailContainer.appendChild(marker);
                
                // Remove after delay
                setTimeout(() => {
                    if (marker.parentNode) {
                        marker.parentNode.removeChild(marker);
                    }
                }, 500);
            },
            
            // End current delivery
            endDelivery: function() {
                GameState.isBallInPlay = false;
                GameState.ballsFaced++;
                
                // Update UI
                updateHUD();
                
                // Check if innings should end
                if (GameState.checkInningsEnd()) {
                    endGame();
                } else {
                    // Prepare for next ball
                    setTimeout(() => {
                        GameState.isReadyForBall = true;
                        hideBall();
                        this.resetBails();
                        
                        // Auto-bowl in practice mode
                        if (GameState.mode === 'practice') {
                            setTimeout(() => {
                                if (GameState.isPlaying && !GameState.isPaused) {
                                    bowlBall();
                                }
                            }, 1500);
                        }
                    }, 1500);
                }
            },
            
            /**
             * Show dust particle effect when ball bounces on pitch
             * Creates realistic dust cloud animation
             */
            showDustParticles: function(x, y, z) {
                const dustContainer = document.getElementById('dust-particles');
                if (!dustContainer) return;
                
                // Position at bounce location
                dustContainer.setAttribute('position', `${x} ${y} ${z}`);
                dustContainer.setAttribute('visible', 'true');
                
                // Get all dust particle elements
                const dustEls = dustContainer.querySelectorAll('.dust-particle');
                
                // Animate each particle
                dustEls.forEach((d, i) => {
                    const angle = (i / dustEls.length) * Math.PI * 2 + Math.random() * 0.5;
                    const distance = 0.1 + Math.random() * 0.15;
                    
                    // Random initial position near center
                    const startX = (Math.random() - 0.5) * 0.05;
                    const startZ = (Math.random() - 0.5) * 0.05;
                    
                    d.setAttribute('position', `${startX} 0 ${startZ}`);
                    d.setAttribute('scale', '1 1 1');
                    d.setAttribute('material', 'color: #c4a35a; opacity: 0.5; transparent: true; shader: flat');
                    
                    // Animate outward and upward
                    const endX = Math.cos(angle) * distance;
                    const endY = 0.15 + Math.random() * 0.1;
                    const endZ = Math.sin(angle) * distance;
                    
                    d.setAttribute('animation', `property: position; to: ${endX} ${endY} ${endZ}; dur: 400; easing: easeOutQuad`);
                    d.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 400; easing: easeInQuad');
                    d.setAttribute('animation__scale', 'property: scale; to: 2.5 2.5 2.5; dur: 400; easing: easeOutQuad');
                });
                
                // Hide and reset after animation
                setTimeout(() => {
                    dustContainer.setAttribute('visible', 'false');
                    dustEls.forEach(d => {
                        d.removeAttribute('animation');
                        d.removeAttribute('animation__fade');
                        d.removeAttribute('animation__scale');
                        d.setAttribute('scale', '1 1 1');
                    });
                }, 450);
            },
            
            /**
             * Show stump LED glow effect when bowled
             */
            showStumpGlow: function() {
                const glowEffect = document.getElementById('stump-glow-effect');
                const ledRing = document.getElementById('stump-led-ring');
                
                if (glowEffect) {
                    glowEffect.setAttribute('visible', 'true');
                    glowEffect.setAttribute('animation', 'property: scale; from: 1 1 1; to: 3 3 3; dur: 500; easing: easeOutQuad');
                    glowEffect.setAttribute('animation__fade', 'property: material.opacity; from: 0.5; to: 0; dur: 500; easing: easeInQuad');
                    
                    setTimeout(() => {
                        glowEffect.setAttribute('visible', 'false');
                        glowEffect.removeAttribute('animation');
                        glowEffect.removeAttribute('animation__fade');
                    }, 550);
                }
                
                if (ledRing) {
                    ledRing.setAttribute('material', 'color: #ff0000; emissive: #ff0000; emissiveIntensity: 1');
                    setTimeout(() => {
                        ledRing.setAttribute('material', 'color: #ff0000; emissive: #ff0000; emissiveIntensity: 0.1');
                    }, 1500);
                }
            }
        };
        
        // ========================================================================
        // BATTING SYSTEM
        // ========================================================================
        
        const BattingSystem = {
            lastFrameTime: 0,
            velocityHistory: [],
            
            // Update bat tracking
            updateBat: function(position, rotation) {
                const now = performance.now();
                const deltaTime = (now - this.lastFrameTime) / 1000;
                this.lastFrameTime = now;
                
                if (deltaTime > 0 && deltaTime < 0.1) {
                    // Calculate velocity
                    GameState.batVelocity = {
                        x: (position.x - GameState.batPrevPosition.x) / deltaTime,
                        y: (position.y - GameState.batPrevPosition.y) / deltaTime,
                        z: (position.z - GameState.batPrevPosition.z) / deltaTime
                    };
                    
                    // Store velocity history for averaging
                    this.velocityHistory.push({...GameState.batVelocity});
                    if (this.velocityHistory.length > 5) {
                        this.velocityHistory.shift();
                    }
                }
                
                // Update previous position
                GameState.batPrevPosition = {...position};
                GameState.batPosition = position;
                GameState.batRotation = rotation;
            },
            
            // Get average bat velocity
            getAverageVelocity: function() {
                if (this.velocityHistory.length === 0) {
                    return { x: 0, y: 0, z: 0 };
                }
                
                const avg = { x: 0, y: 0, z: 0 };
                this.velocityHistory.forEach(v => {
                    avg.x += v.x;
                    avg.y += v.y;
                    avg.z += v.z;
                });
                
                avg.x /= this.velocityHistory.length;
                avg.y /= this.velocityHistory.length;
                avg.z /= this.velocityHistory.length;
                
                return avg;
            },
            
            // Get bat speed
            getBatSpeed: function() {
                const vel = this.getAverageVelocity();
                return Math.sqrt(vel.x * vel.x + vel.y * vel.y + vel.z * vel.z);
            },
            
            // Check bat-ball collision
            checkCollision: function() {
                if (!GameState.isBallInPlay || GameState.ballHitByBat) return;
                
                const ball = GameState.ballPosition;
                const bat = GameState.batPosition;
                
                // Get bat world position (accounting for controller position)
                const rightHand = document.getElementById('right-hand');
                if (!rightHand) return;
                
                const batWorldPos = rightHand.object3D.position.clone();
                const batEntity = document.getElementById('cricket-bat');
                if (batEntity) {
                    // Add bat offset
                    batWorldPos.y += 0.5; // Bat blade center
                }
                
                // Calculate distance to bat blade
                const dx = ball.x - batWorldPos.x;
                const dy = ball.y - batWorldPos.y;
                const dz = ball.z - batWorldPos.z;
                const distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                
                // Collision threshold - use config value
                const collisionThreshold = CONFIG.batCollisionRadius;
                
                if (distance < collisionThreshold) {
                    console.log(`üèè BAT-BALL COLLISION! Distance: ${distance.toFixed(3)}`);
                    this.handleHit(batWorldPos, distance);
                }
            },
            
            /**
             * Handle bat hitting ball
             * Calculate shot power, direction, and trigger feedback
             */
            handleHit: function(batWorldPos, collisionDistance) {
                GameState.ballHitByBat = true;
                
                // Get bat velocity and speed
                const batVel = this.getAverageVelocity();
                const batSpeed = this.getBatSpeed();
                
                // Determine hit quality based on contact point
                const ball = GameState.ballPosition;
                const hitQuality = this.calculateHitQuality(ball, batWorldPos, collisionDistance);
                
                // Show timing indicator
                showTimingIndicator(hitQuality);
                
                // Determine shot type based on bat movement
                const shotType = this.determineShotType(batVel, GameState.batRotation);
                
                // Calculate new ball velocity
                const powerMultiplier = this.getPowerMultiplier(hitQuality);
                const baseSpeed = Math.max(batSpeed * powerMultiplier * 2, 10); // Minimum speed of 10 m/s
                
                // Direction based on shot type and bat angle
                let newVel = this.calculateShotVelocity(shotType, batVel, baseSpeed, hitQuality);
                
                GameState.ballVelocity = newVel;
                
                console.log(`üèè Shot: ${shotType}, Quality: ${hitQuality}, Speed: ${baseSpeed.toFixed(1)} m/s`);
                console.log(`üèè New ball velocity: (${newVel.x.toFixed(2)}, ${newVel.y.toFixed(2)}, ${newVel.z.toFixed(2)})`);
                
                // Visual and audio feedback
                this.showHitFeedback(hitQuality, shotType);
                AudioSystem.playBatHit(hitQuality);
                
                // Update HUD with shot type
                document.getElementById('hud-shot').textContent = shotType;
                const vrShotText = document.getElementById('vr-shot-text');
                if (vrShotText) {
                    vrShotText.setAttribute('value', shotType);
                }
            },
            
            /**
             * Calculate hit quality based on contact point
             * Perfect = sweet spot, Good = close to middle, Fair = off-center, Edge = bat edge
             */
            calculateHitQuality: function(ballPos, batPos, distance) {
                const dy = Math.abs(ballPos.y - batPos.y);
                const dx = Math.abs(ballPos.x - batPos.x);
                
                // Use collision distance for quality assessment
                const sweetSpotThreshold = CONFIG.sweetSpotSize;
                
                // Sweet spot detection
                if (distance < sweetSpotThreshold && dy < 0.1 && dx < 0.05) {
                    return 'perfect';
                } else if (distance < sweetSpotThreshold * 1.5 && dy < 0.15) {
                    return 'good';
                } else if (dx > 0.08) {
                    return 'edge';
                } else {
                    return 'fair';
                }
            },
            
            /**
             * Determine shot type based on bat movement direction
             */
            determineShotType: function(velocity, rotation) {
                const vx = velocity.x;
                const vy = velocity.y;
                const vz = velocity.z;
                
                // Horizontal vs vertical movement
                const horizontalSpeed = Math.sqrt(vx * vx + vz * vz);
                const verticalSpeed = Math.abs(vy);
                
                // Direction of horizontal movement
                const isOffSide = vx > 0.5;
                const isLegSide = vx < -0.5;
                const isForward = vz < -0.5;
                const isBackward = vz > 0.5;
                
                // Determine shot
                if (verticalSpeed > horizontalSpeed * 1.5) {
                    if (vy > 0) {
                        return 'Lofted Shot';
                    } else {
                        return 'Defensive Block';
                    }
                }
                
                if (isForward) {
                    if (isOffSide) return 'Cover Drive';
                    if (isLegSide) return 'On Drive';
                    return 'Straight Drive';
                }
                
                if (isBackward) {
                    if (isOffSide) return 'Late Cut';
                    if (isLegSide) return 'Flick';
                    return 'Defensive';
                }
                
                if (horizontalSpeed > 3) {
                    if (isOffSide) return 'Cut Shot';
                    if (isLegSide) return 'Pull Shot';
                }
                
                return 'Shot';
            },
            
            /**
             * Get power multiplier based on hit quality
             */
            getPowerMultiplier: function(quality) {
                switch (quality) {
                    case 'perfect': return 1.8;  // Sweet spot = maximum power
                    case 'good': return 1.4;
                    case 'fair': return 1.0;
                    case 'edge': return 0.5;     // Edge = much less power
                    default: return 0.8;
                }
            },
            
            /**
             * Calculate ball velocity after being hit
             * Uses bat velocity and quality to determine shot power and direction
             */
            calculateShotVelocity: function(shotType, batVel, baseSpeed, quality) {
                let vx = 0, vy = 0, vz = 0;
                
                // Base direction from bat velocity
                const batMag = Math.sqrt(batVel.x * batVel.x + batVel.y * batVel.y + batVel.z * batVel.z);
                if (batMag > 0) {
                    vx = (batVel.x / batMag) * baseSpeed;
                    vy = (batVel.y / batMag) * baseSpeed;
                    vz = (batVel.z / batMag) * baseSpeed;
                }
                
                // Ensure ball goes away from batsman
                if (vz > 0) vz = -vz;
                
                // Add upward component for lofted shots
                if (Math.abs(batVel.y) > 2) {
                    vy = Math.abs(vy) * 0.5;
                }
                
                // Edge deflection
                if (quality === 'edge') {
                    vx += (Math.random() - 0.5) * baseSpeed * 0.5;
                    vz *= 0.3;
                }
                
                // Minimum forward velocity
                if (Math.abs(vz) < 5) {
                    vz = -5;
                }
                
                // Add slight randomness
                vx += (Math.random() - 0.5) * 2;
                vy += (Math.random() - 0.5) * 2;
                
                return { x: vx, y: Math.max(vy, 2), z: vz };
            },
            
            // Show hit feedback visuals
            showHitFeedback: function(quality, shotType) {
                const batBlade = document.getElementById('bat-blade');
                const sweetSpot = document.getElementById('sweet-spot');
                
                let color = '#FFFFFF';
                if (quality === 'perfect') color = '#00FF00';
                else if (quality === 'good') color = '#FFFF00';
                else if (quality === 'edge') color = '#FF0000';
                
                // Flash bat with glow effect
                if (batBlade) {
                    batBlade.setAttribute('material', `color: ${color}; emissive: ${color}; emissiveIntensity: 0.3; roughness: 0.7`);
                    setTimeout(() => {
                        batBlade.setAttribute('material', 'color: #f5e6c8; emissive: #000000; emissiveIntensity: 0; roughness: 0.7; metalness: 0');
                    }, 200);
                }
                
                // Show enhanced hit particles with animation
                this.showHitParticles(GameState.ballPosition, quality, color);
            },
            
            /**
             * Enhanced hit particle effect with animated sparks
             */
            showHitParticles: function(position, quality, color) {
                const particles = document.getElementById('hit-particles');
                if (!particles) return;
                
                // Position at hit location
                particles.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
                particles.setAttribute('visible', 'true');
                
                // Get all particle elements
                const particleEls = particles.querySelectorAll('.hit-particle');
                
                // Animate each particle with different directions
                particleEls.forEach((p, i) => {
                    const angle = (i / particleEls.length) * Math.PI * 2;
                    const speed = quality === 'perfect' ? 0.3 : quality === 'good' ? 0.2 : 0.1;
                    
                    // Random initial offset
                    const ox = Math.cos(angle) * 0.05;
                    const oy = Math.random() * 0.05;
                    const oz = Math.sin(angle) * 0.05;
                    
                    p.setAttribute('position', `${ox} ${oy} ${oz}`);
                    p.setAttribute('material', `color: ${color}; emissive: ${color}; emissiveIntensity: 0.8; shader: flat; opacity: 0.9; transparent: true`);
                    
                    // Animate outward
                    const endX = Math.cos(angle) * speed;
                    const endY = 0.1 + Math.random() * 0.1;
                    const endZ = Math.sin(angle) * speed;
                    
                    p.setAttribute('animation', `property: position; to: ${endX} ${endY} ${endZ}; dur: 300; easing: easeOutQuad`);
                    p.setAttribute('animation__fade', 'property: material.opacity; to: 0; dur: 300; easing: linear');
                    p.setAttribute('animation__scale', 'property: scale; to: 2 2 2; dur: 300; easing: easeOutQuad');
                });
                
                // Hide after animation
                setTimeout(() => {
                    particles.setAttribute('visible', 'false');
                    particleEls.forEach(p => {
                        p.removeAttribute('animation');
                        p.removeAttribute('animation__fade');
                        p.removeAttribute('animation__scale');
                        p.setAttribute('scale', '1 1 1');
                    });
                }, 350);
            }
        };
        
        // ========================================================================
        // UI FUNCTIONS
        // ========================================================================
        
        function showShotFeedback(text, type) {
            const feedback = document.getElementById('shot-feedback');
            feedback.textContent = text;
            feedback.className = `show ${type}`;
            
            // Also update VR HUD shot text
            const vrShotText = document.getElementById('vr-shot-text');
            if (vrShotText) {
                let color = '#ffffff';
                if (type === 'six') color = '#ff00ff';
                else if (type === 'four') color = '#00ff00';
                else if (type === 'out') color = '#ff0000';
                else if (type === 'runs') color = '#ffff00';
                
                vrShotText.setAttribute('value', text);
                vrShotText.setAttribute('color', color);
                
                // Animate the text
                vrShotText.setAttribute('animation', 'property: scale; from: 1.5 1.5 1.5; to: 0.5 0.5 0.5; dur: 1500; easing: easeOutQuad');
                
                setTimeout(() => {
                    vrShotText.setAttribute('value', '');
                    vrShotText.removeAttribute('animation');
                    vrShotText.setAttribute('scale', '0.5 0.5 0.5');
                }, 1500);
            }
            
            setTimeout(() => {
                feedback.className = '';
            }, 1500);
        }
        
        /**
         * Show timing indicator when ball is hit
         * @param {string} quality - 'perfect', 'good', or 'poor'
         */
        function showTimingIndicator(quality) {
            const indicator = document.getElementById('timing-indicator');
            if (!indicator) return;
            
            let text = '';
            switch (quality) {
                case 'perfect':
                    text = '‚ö° PERFECT!';
                    break;
                case 'good':
                    text = 'üëç GOOD';
                    break;
                default:
                    text = 'üò¨ POOR';
            }
            
            indicator.textContent = text;
            indicator.className = `show ${quality}`;
            
            setTimeout(() => {
                indicator.className = '';
            }, 1000);
        }
        
        function updateHUD() {
            document.getElementById('hud-runs').textContent = GameState.runs;
            document.getElementById('hud-wickets').textContent = GameState.wickets;
            document.getElementById('hud-balls').textContent = GameState.ballsFaced;
            document.getElementById('hud-fours').textContent = GameState.fours;
            document.getElementById('hud-sixes').textContent = GameState.sixes;
            document.getElementById('hud-sr').textContent = GameState.getStrikeRate();
            
            // Update VR HUD with all elements
            const vrScoreText = document.getElementById('vr-score-text');
            const vrBallsText = document.getElementById('vr-balls-text');
            const vrSrText = document.getElementById('vr-sr-text');
            
            if (vrScoreText) {
                vrScoreText.setAttribute('value', `${GameState.runs}/${GameState.wickets}`);
            }
            if (vrBallsText) {
                const overs = Math.floor(GameState.ballsFaced / 6);
                const balls = GameState.ballsFaced % 6;
                vrBallsText.setAttribute('value', `Overs: ${overs}.${balls}  (${GameState.ballsFaced} balls)`);
            }
            if (vrSrText) {
                vrSrText.setAttribute('value', `SR: ${GameState.getStrikeRate()} | 4s: ${GameState.fours} | 6s: ${GameState.sixes}`);
            }
        }

        function showVRHUD(show) {
            const elements = ['vr-scoreboard', 'vr-score-text', 'vr-balls-text', 'vr-shot-text', 'vr-sr-text'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('visible', show);
            });
            
            // Also show/hide accent bar
            const accentBar = document.querySelector('.vr-hud-element');
            if (accentBar) accentBar.setAttribute('visible', show);
            
            // Clear trail
            const trailContainer = document.getElementById('ball-trail');
            if (trailContainer) {
                trailContainer.innerHTML = '';
            }
        }
        
        function showBall() {
            const ball = document.getElementById('cricket-ball');
            if (ball) {
                ball.setAttribute('visible', 'true');
            }
        }
        
        // ========================================================================
        // GAME CONTROL FUNCTIONS
        // ========================================================================
        
        function startGame() {
            // Get selected options
            const modeBtn = document.querySelector('[data-mode].active');
            const difficultyBtn = document.querySelector('[data-difficulty].active');
            const oversBtn = document.querySelector('[data-overs].active');
            
            GameState.mode = modeBtn ? modeBtn.dataset.mode : 'practice';
            GameState.difficulty = difficultyBtn ? difficultyBtn.dataset.difficulty : 'medium';
            GameState.totalOvers = oversBtn ? parseInt(oversBtn.dataset.overs) : 1;
            
            // Set target for target chase mode
            if (GameState.mode === 'target') {
                const baseTarget = GameState.totalOvers * 8; // ~8 runs per over average
                GameState.targetScore = baseTarget + Math.floor(Math.random() * (GameState.totalOvers * 4));
                document.getElementById('hud-target').textContent = GameState.targetScore;
                document.getElementById('hud-target-row').style.display = 'flex';
            } else {
                document.getElementById('hud-target-row').style.display = 'none';
            }
            
            // Reset state
            GameState.reset();
            
            // Update UI
            document.getElementById('menu-overlay').classList.add('hidden');
            document.getElementById('game-hud').classList.remove('hidden');
            updateHUD();
            
            // Initialize audio on user interaction
            AudioSystem.init();
            
            // Reset bails
            PhysicsSystem.resetBails();
            
            // Show VR HUD
            showVRHUD(true);
            
            // Start first ball after delay
            setTimeout(() => {
                bowlBall();
            }, 2000);
        }
        
        function bowlBall() {
            if (!GameState.isPlaying || GameState.isPaused || GameState.isBallInPlay) return;
            
            // Reset physics system bounce counter
            PhysicsSystem.bounceCount = 0;
            
            // Generate delivery with proper physics
            const delivery = BowlingSystem.generateDelivery();
            
            console.log('==========================================');
            console.log('üèè BOWLING DELIVERY');
            console.log('==========================================');
            console.log(`Type: ${delivery.type}, Line: ${delivery.line}`);
            console.log(`Speed: ${delivery.speedKmh.toFixed(1)} km/h (${delivery.speed.toFixed(1)} m/s)`);
            console.log(`Start Position: (${delivery.startPos.x.toFixed(2)}, ${delivery.startPos.y.toFixed(2)}, ${delivery.startPos.z.toFixed(2)})`);
            console.log(`Velocity: (${delivery.velocity.x.toFixed(2)}, ${delivery.velocity.y.toFixed(2)}, ${delivery.velocity.z.toFixed(2)})`);
            if (delivery.bounceZ !== null) {
                console.log(`Expected bounce at z: ${delivery.bounceZ.toFixed(2)}`);
            }
            console.log('==========================================');
            
            // Set ball initial state
            GameState.ballPosition = {
                x: delivery.startPos.x,
                y: delivery.startPos.y,
                z: delivery.startPos.z
            };
            GameState.ballVelocity = {
                x: delivery.velocity.x,
                y: delivery.velocity.y,
                z: delivery.velocity.z
            };
            GameState.ballHasBouncedOnPitch = false;
            GameState.ballHitByBat = false;
            GameState.isBallInPlay = true;
            GameState.isReadyForBall = false;
            
            // Show ball at starting position
            showBall();
            const ball = document.getElementById('cricket-ball');
            if (ball) {
                ball.setAttribute('position', `${delivery.startPos.x} ${delivery.startPos.y} ${delivery.startPos.z}`);
            }
            
            // Update ball speed display
            updateBallSpeedDisplay(delivery.speedKmh);
            
            // Animate bowler
            animateBowler();
        }
        
        // Display ball speed in km/h
        function updateBallSpeedDisplay(speedKmh) {
            let speedDisplay = document.getElementById('ball-speed-display');
            if (!speedDisplay) {
                // Create speed display if it doesn't exist
                speedDisplay = document.createElement('div');
                speedDisplay.id = 'ball-speed-display';
                speedDisplay.innerHTML = `
                    <div class="speed-value">${speedKmh.toFixed(0)}</div>
                    <div class="speed-unit">km/h</div>
                `;
                document.body.appendChild(speedDisplay);
            } else {
                speedDisplay.querySelector('.speed-value').textContent = speedKmh.toFixed(0);
                speedDisplay.classList.remove('hidden');
            }
            
            // Hide after 2 seconds
            setTimeout(() => {
                if (speedDisplay) speedDisplay.classList.add('hidden');
            }, 2000);
        }
        
        function animateBowler() {
            const bowlerArm = document.getElementById('bowler-arm-right');
            if (bowlerArm) {
                bowlerArm.setAttribute('animation', {
                    property: 'rotation',
                    from: '0 0 -30',
                    to: '-180 0 -30',
                    dur: 300,
                    easing: 'easeInQuad'
                });
                
                setTimeout(() => {
                    bowlerArm.setAttribute('rotation', '0 0 -30');
                    bowlerArm.removeAttribute('animation');
                }, 500);
            }
        }
        
        function pauseGame() {
            if (!GameState.isPlaying || GameState.isGameOver) return;
            
            GameState.isPaused = true;
            document.getElementById('pause-menu').classList.remove('hidden');
        }
        
        function resumeGame() {
            GameState.isPaused = false;
            document.getElementById('pause-menu').classList.add('hidden');
        }
        
        function restartGame() {
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            
            // Reset and start
            GameState.reset();
            PhysicsSystem.resetBails();
            hideBall();
            updateHUD();
            
            setTimeout(() => {
                bowlBall();
            }, 1500);
        }
        
        function quitToMenu() {
            GameState.isPlaying = false;
            GameState.isPaused = false;
            
            document.getElementById('pause-menu').classList.add('hidden');
            document.getElementById('game-over').classList.add('hidden');
            document.getElementById('game-hud').classList.add('hidden');
            document.getElementById('menu-overlay').classList.remove('hidden');
            
            showVRHUD(false);
            hideBall();
            PhysicsSystem.resetBails();
        }
        
        function endGame() {
            GameState.isPlaying = false;
            GameState.isGameOver = true;
            
            // Determine game over message
            let title = 'INNINGS OVER';
            if (GameState.mode === 'target') {
                if (GameState.runs >= GameState.targetScore) {
                    title = 'üéâ TARGET ACHIEVED!';
                } else {
                    title = 'üòî TARGET MISSED';
                }
            } else if (GameState.mode === 'survival' && GameState.wickets > 0) {
                title = 'OUT!';
            }
            
            document.getElementById('game-over-title').textContent = title;
            document.getElementById('final-score').textContent = GameState.runs;
            document.getElementById('final-balls').textContent = GameState.ballsFaced;
            document.getElementById('final-fours').textContent = GameState.fours;
            document.getElementById('final-sixes').textContent = GameState.sixes;
            document.getElementById('final-sr').textContent = GameState.getStrikeRate();
            document.getElementById('final-best').textContent = GameState.bestShot || 'N/A';
            
            // Update high score
            if (GameState.runs > GameState.highScore) {
                GameState.highScore = GameState.runs;
                localStorage.setItem('cricketHighScore', GameState.runs);
            }
            
            document.getElementById('game-over').classList.remove('hidden');
        }
        
        // ========================================================================
        // GAME LOOP
        // ========================================================================
        
        let lastTime = 0;
        
        function gameLoop(currentTime) {
            requestAnimationFrame(gameLoop);
            
            if (!GameState.isPlaying || GameState.isPaused) return;
            
            const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;
            
            // Update physics
            PhysicsSystem.updateBall(deltaTime);
            
            // Check bat collision
            BattingSystem.checkCollision();
        }
        
        // ========================================================================
        // EVENT LISTENERS & INITIALIZATION
        // ========================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Menu button selection
            document.querySelectorAll('.menu-btn[data-mode]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            document.querySelectorAll('.menu-btn[data-difficulty]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-difficulty]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            document.querySelectorAll('.menu-btn[data-overs]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-overs]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Game control buttons
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('resume-btn').addEventListener('click', resumeGame);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
            document.getElementById('quit-btn').addEventListener('click', quitToMenu);
            document.getElementById('play-again-btn').addEventListener('click', restartGame);
            document.getElementById('menu-btn').addEventListener('click', quitToMenu);
            
            // Keyboard controls (for testing)
            document.addEventListener('keydown', function(e) {
                // Escape: Pause/Resume
                if (e.key === 'Escape') {
                    if (GameState.isPaused) {
                        resumeGame();
                    } else if (GameState.isPlaying) {
                        pauseGame();
                    }
                }
                
                // Spacebar: Bowl next ball (when ready)
                if (e.key === ' ' && GameState.isPlaying && !GameState.isBallInPlay) {
                    e.preventDefault();
                    bowlBall();
                }
                
                // D key: Toggle debug mode
                if (e.key === 'd' || e.key === 'D') {
                    CONFIG.debugMode = !CONFIG.debugMode;
                    console.log(`üîß Debug mode: ${CONFIG.debugMode ? 'ON' : 'OFF'}`);
                    
                    // Show/hide debug panel
                    let debugPanel = document.getElementById('debug-panel');
                    if (CONFIG.debugMode) {
                        if (!debugPanel) {
                            debugPanel = document.createElement('div');
                            debugPanel.id = 'debug-panel';
                            document.body.appendChild(debugPanel);
                        }
                        debugPanel.classList.remove('hidden');
                        updateDebugPanel();
                    } else if (debugPanel) {
                        debugPanel.classList.add('hidden');
                    }
                }
                
                // B key: Force bowl a ball (for testing)
                if ((e.key === 'b' || e.key === 'B') && GameState.isPlaying) {
                    console.log('üîß Force bowling ball...');
                    GameState.isBallInPlay = false;
                    bowlBall();
                }
            });
            
            // Debug panel update
            function updateDebugPanel() {
                if (!CONFIG.debugMode) return;
                
                const panel = document.getElementById('debug-panel');
                if (!panel) return;
                
                const ball = GameState.ballPosition;
                const vel = GameState.ballVelocity;
                const speed = Math.sqrt(vel.x*vel.x + vel.y*vel.y + vel.z*vel.z);
                
                panel.innerHTML = `
                    <strong>DEBUG MODE</strong><br>
                    Ball Position: (${ball.x.toFixed(2)}, ${ball.y.toFixed(2)}, ${ball.z.toFixed(2)})<br>
                    Ball Velocity: (${vel.x.toFixed(2)}, ${vel.y.toFixed(2)}, ${vel.z.toFixed(2)})<br>
                    Speed: ${(speed * 3.6).toFixed(1)} km/h<br>
                    In Play: ${GameState.isBallInPlay}<br>
                    Bounced: ${GameState.ballHasBouncedOnPitch}<br>
                    Delivery: ${GameState.currentDeliveryType}<br>
                    Line: ${GameState.currentLine}
                `;
            }
            
            // Update debug panel periodically
            setInterval(updateDebugPanel, 100);
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        });
        
        // ========================================================================
        // VR MODE STATE TRACKING & SCENE INITIALIZATION
        // ========================================================================
        
        // Track VR mode to prevent auto-pause issues
        let isVRMode = false;
        let vrTransitioning = false;
        
        const scene = document.querySelector('a-scene');
        if (scene) {
            scene.addEventListener('loaded', function() {
                console.log('üéÆ VR Cricket Scene Loaded!');
                
                // Set up controller tracking
                const rightHand = document.getElementById('right-hand');
                
                if (rightHand) {
                    // Track controller movement
                    rightHand.addEventListener('controllerconnected', function() {
                        console.log('‚úÖ Right controller connected');
                    });
                    
                    // Grip button for pause (MANUAL PAUSE ONLY)
                    rightHand.addEventListener('gripdown', function() {
                        if (GameState.isPlaying && !GameState.isPaused) {
                            console.log('‚è∏ Manual pause triggered by grip button');
                            pauseGame();
                        }
                    });
                    
                    // Track bat position continuously
                    setInterval(function() {
                        if (rightHand.object3D) {
                            const pos = rightHand.object3D.position;
                            const rot = rightHand.object3D.rotation;
                            BattingSystem.updateBat(
                                { x: pos.x, y: pos.y, z: pos.z },
                                { x: rot.x, y: rot.y, z: rot.z }
                            );
                        }
                    }, 16); // ~60fps tracking
                }
                
                const leftHand = document.getElementById('left-hand');
                if (leftHand) {
                    // Trigger for ready/next ball
                    leftHand.addEventListener('triggerdown', function() {
                        if (GameState.isPlaying && !GameState.isPaused && GameState.isReadyForBall) {
                            bowlBall();
                        }
                    });
                    
                    // Grip for reset position
                    leftHand.addEventListener('gripdown', function() {
                        const rig = document.getElementById('rig');
                        if (rig) {
                            rig.setAttribute('position', '0 0 0');
                            console.log('üîÑ Player position reset');
                        }
                    });
                }
            });
            
            // ================================================================
            // VR MODE ENTER - CRITICAL FIX FOR AUTO-PAUSE
            // ================================================================
            scene.addEventListener('enter-vr', function() {
                console.log('ü•Ω ENTERING VR MODE');
                
                // Set VR mode flag
                isVRMode = true;
                vrTransitioning = true;
                
                // FORCE RESUME if game was auto-paused during transition
                if (GameState.isPlaying && GameState.isPaused) {
                    console.log('‚ö†Ô∏è Auto-pause detected, forcing resume...');
                    GameState.isPaused = false;
                }
                
                // Show VR HUD
                showVRHUD(true);
                
                // Clear transition flag after delay
                setTimeout(() => {
                    vrTransitioning = false;
                    console.log('‚úÖ VR transition complete, game active');
                }, 200);
            });
            
            // ================================================================
            // VR MODE EXIT
            // ================================================================
            scene.addEventListener('exit-vr', function() {
                console.log('üñ•Ô∏è EXITING VR MODE');
                
                // Clear VR mode flag
                isVRMode = false;
                vrTransitioning = false;
                
                // Hide VR HUD
                showVRHUD(false);
                
                console.log('‚úÖ Returned to desktop mode');
            });
        }
        
        // ====================================================================
        // BROWSER VISIBILITY CHANGE HANDLER
        // FIX: Don't pause when in VR mode (headset on/off triggers this)
        // ====================================================================
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('üëÅÔ∏è Page visibility: HIDDEN');
                
                // Only pause if NOT in VR mode
                if (!isVRMode && GameState.isPlaying && !GameState.isPaused) {
                    console.log('‚è∏ Pausing game (page hidden, not in VR)');
                    pauseGame();
                } else if (isVRMode) {
                    console.log('ü•Ω In VR mode - ignoring visibility change');
                    // Force resume if accidentally paused
                    GameState.isPaused = false;
                }
            } else {
                console.log('üëÅÔ∏è Page visibility: VISIBLE');
                
                // Don't auto-resume, user must manually resume
                // This prevents unwanted resumption
            }
        });
        
        // ====================================================================
        // WINDOW BLUR EVENT HANDLER
        // FIX: Don't pause when entering VR (window loses focus)
        // ====================================================================
        window.addEventListener('blur', function() {
            console.log('üî≤ Window blur detected');
            
            // If in VR mode, don't pause
            if (isVRMode && GameState.isPlaying) {
                console.log('ü•Ω In VR mode - preventing auto-pause from blur');
                
                // Add small delay and force resume if paused
                setTimeout(() => {
                    if (GameState.isPaused && !vrTransitioning) {
                        console.log('‚ö†Ô∏è Auto-pause detected during VR, forcing resume');
                        GameState.isPaused = false;
                    }
                }, 100);
            } else if (!isVRMode && GameState.isPlaying && !GameState.isPaused) {
                // Only pause on blur when NOT in VR mode
                console.log('‚è∏ Pausing game (window blur, not in VR)');
                pauseGame();
            }
        });
        
        // ====================================================================
        // WINDOW FOCUS EVENT HANDLER
        // ====================================================================
        window.addEventListener('focus', function() {
            console.log('üî≥ Window focus regained');
            
            // Don't auto-resume, let user control this
            // This prevents unwanted behavior
        });
        
        // ====================================================================
        // ADDITIONAL VR DEBUGGING
        // ====================================================================
        // Log VR state periodically for debugging
        if (CONFIG.debugMode) {
            setInterval(() => {
                if (isVRMode) {
                    console.log(`ü•Ω VR Mode Active | Paused: ${GameState.isPaused} | Playing: ${GameState.isPlaying}`);
                }
            }, 5000);
        }
        
        // Mouse/Touch controls for non-VR testing
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        document.addEventListener('mousedown', function(e) {
            if (e.target.tagName === 'CANVAS') {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging && GameState.isPlaying) {
                const deltaX = (e.clientX - lastMouseX) * 0.01;
                const deltaY = (e.clientY - lastMouseY) * 0.01;
                
                // Simulate bat movement for testing
                BattingSystem.updateBat(
                    { 
                        x: GameState.batPosition.x + deltaX, 
                        y: GameState.batPosition.y - deltaY, 
                        z: GameState.batPosition.z 
                    },
                    GameState.batRotation
                );
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
        
        // Click to hit for desktop testing
        // Simulates a bat swing when ball is in the hitting zone
        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'CANVAS' && GameState.isBallInPlay && !GameState.ballHitByBat) {
                // Ball is in hitting zone when z is between -3 and 2
                const ball = GameState.ballPosition;
                console.log(`üñ±Ô∏è Click detected. Ball at z=${ball.z.toFixed(2)}`);
                
                if (ball.z > -3 && ball.z < 2) {
                    console.log('üèè Ball in hitting zone! Simulating hit...');
                    
                    // Simulate a hit for desktop testing
                    const simulatedBatPos = { 
                        x: ball.x + (Math.random() - 0.5) * 0.1, 
                        y: ball.y + (Math.random() - 0.5) * 0.1, 
                        z: ball.z 
                    };
                    
                    // Create simulated bat velocity (as if swinging)
                    const swingDirection = Math.random() > 0.5 ? 1 : -1;  // Off side or leg side
                    BattingSystem.velocityHistory = [
                        { 
                            x: swingDirection * (3 + Math.random() * 5),  // Horizontal swing
                            y: 2 + Math.random() * 3,                      // Slight upward motion
                            z: -6 - Math.random() * 6                      // Forward momentum
                        }
                    ];
                    
                    BattingSystem.handleHit(simulatedBatPos, 0.1);
                } else {
                    console.log(`‚ö†Ô∏è Ball not in hitting zone (z=${ball.z.toFixed(2)}). Zone is -3 to 2.`);
                }
            }
        });
        
        // Log help message on startup
        console.log('==========================================');
        console.log('üèè VR CRICKET PRO - Debug Controls');
        console.log('==========================================');
        console.log('SPACEBAR: Bowl next ball');
        console.log('B: Force bowl (bypass checks)');
        console.log('D: Toggle debug mode');
        console.log('ESC: Pause/Resume');
        console.log('CLICK on canvas: Simulate bat hit');
        console.log('==========================================');
        
    })();
    </script>
</body>
</html>
